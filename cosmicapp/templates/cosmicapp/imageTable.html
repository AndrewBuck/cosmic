{% include "./jquery.html" %}

<script>
var numRows, numCols;
var includeLinks = {{includeLinks}};
var thumbnailSize = "{{thumbnailSize}}"

var firstLoadOfGallery = true;
var loadingInProgress = false;

var paramIdCounter = 0;

var lastParamString = '';
var offset = 0;

function initImageGallery()
{
    $(window).on('resize', handleWindowResize)
    handleWindowResize();

    addQueryParameter('{{queryParams}}');
    loadImageGalleryResults();
};

function addQueryParameter(paramString)
{
    if(paramString === undefined || paramString == '')
        paramString = 'imageProperty=';

    params = paramString.split('&');
    for(i = 0; i < params.length; i++)
    {
        html = ''

        paramIdCounter++;

        html += '<div id="paramDiv_' + paramIdCounter + '" class=imageGalleryParameter>';
        if(paramIdCounter > 1)
            html += '<i>AND</i>&nbsp;';

        html += '<select class="paramSelect" id="paramSelect' + paramIdCounter + '">'
        html += '<option value="user">User</option>'
        html += '<option value="id">Image ID</option>'
        html += '<option value="imageProperty">Image Property</option>'
        html += '<option value="questionAnswer">Question Answer</option>'
        html += '</select>&nbsp;'

        kv = params[i].split('=');
        key = kv[0];
        //NOTE: The slice and join here handles when the value portion contains an '=' sign in the original input.
        value = kv.slice(1, kv.length).join('=');

        html += '<input class="paramTextbox" type=text id="paramTextbox' + paramIdCounter + '" value="' + value + '">';

        if(paramIdCounter > 1)
            html += '&nbsp;<input type=button class=button style="margin: 3px" value="Remove" id="removeButton' + paramIdCounter + '"><br>'

        html += '</div>'

        $('#imageGalleryQueriesDiv').append(html);

        $('#paramSelect' + paramIdCounter).val(key);
        $('#removeButton' + paramIdCounter).click(function()
        {
            $(this).parent().remove();
        });
    }
};

function queryHelp()
{
    html  = '<div class="imageGalleryZoomWindow">';
    html += '<div style="padding: 2em; background: white; width: 70%; overflow-y: auto;">'
    html += '<h2>Query Help</h2>'
    html += `
            <p>The image gallery is used on many pages and allows you to select and view a list of images which are
            pulled from the server using a database query.  Changing the query parameters allows you to limit the
            displayed images to a specific subset of the images in the database.</p>

            <h3>Default Query Filter</h3>
            <p>On most pages, when the gallery loads the default query will be to show your own images, starting from
            your most recently uploaded images and going back from there.  On these pages you will see a single filter
            listed, showing 'User' as the filter type and your username in the text box beside it.  Changing the
            username in the field will show images created by that user for future loading operations, but will not
            clear the already loaded images unless you press the 'Clear Results' button first.</p>

            <h3>Additional Filters</h3>
            <p>Clicking the 'Add Query Filter' button will add a second filter to further limit the returned results.
            You can choose from several types of filters using the dropdown box on the left and then enter the text for
            the filter into the text box on the right.</p>

            <h3>Logical Operators: <i>AND</i> and <i>OR</i></h3>
            <p>If multiple filters are selected the returned results must meet <i>all</i> of the conditions specified
            in the filters.  In technical terms this means the filters are combined using the logical <i>AND</i>
            operator.  You can also specify that you want to return all images that meet any one of several different
            conditions by separating the conditions using a pipe character (which looks like | and is found near the
            'Enter' key on most keyboards).  The pipe character represents the logical <i>OR</i> operator.</p>

            <p>Note that when using the | character, any spaces before or after the character will be stripped away so
            'user1|user2' is equivalent to 'user1 | user2'.  Use whichever is more convenient for you.</p>

            <h3>Examples</h3>
            <p>Show all your calibration frames:</p>
            <table border=2px>
                <tr><th> Filter </th><th> Value </th></tr>
                <tr><td> User </td><td> yourUserName </td></tr>
                <tr><td> <i>AND</i> Image Property </td><td> imageType=dark | imageType=bias | imageType=light </td></tr>
            </table>
             `
    html += '</div>'
    html += '</div>';

    $(document.body).append(html);

    $('.imageGalleryZoomWindow').click(function()
    {
        $(this).remove();
    });
};

function zoomImage(id)
{
    thumbUrl = $.ajax(
        {url: '/image/' + id + '/thumbnail/full/',
        async: false}
        ).responseText;

    html  = '<div class="imageGalleryZoomWindow">';
    html += '<img src="' + thumbUrl + '">';
    html += '</div>';

    $(document.body).append(html);

    $('.imageGalleryZoomWindow').click(function()
    {
        $(this).remove();
    });
};

function loadImageGalleryResults()
{
    if(!loadingInProgress)
    {
        loadingInProgress = true;

        gallery = document.getElementById("imageGalleryDiv");
        currentHTML = gallery.innerHTML;
        $('#imageGalleryDiv').append('<div id="imageGalleryLoadingMessage"><p>Loading...</p><div>');

        params = document.getElementsByClassName('imageGalleryParameter');
        paramArray = [];
        for(i = 0; i < params.length; i++)
        {
            paramId = params[i].getAttribute('id').split('_')[1];
            key = document.getElementById('paramSelect' + paramId).value;
            value = document.getElementById('paramTextbox' + paramId).value;
            paramArray[paramArray.length] = key + "=" + value
        }

        paramString = paramArray.join('&');
        if(paramString != lastParamString)
            offset = 0;

        lastParamString = paramString;

        $.get('/query/?queryfor=image&' + paramString + '&order=time_desc&limit=' + numRows*numCols +
                    '&offset=' + offset, function(xml, statusCode)
        {
            html = ""

            results = xml.getElementsByTagName('Image')

            $('#newResultsDivider').remove();
            if(!firstLoadOfGallery)
            {
                html += '<div id=newResultsDivider class=responsive style="text-align: center; width: 95%; border: 1em solid blue">'
                if(results.length > 0)
                    html += 'New Results:</div>'
                else
                    html += 'No more results to display.</div>'
            }

            for(i = 0; i < results.length; i++)
            {
                attr = results[i].attributes;
                imageId = attr.getNamedItem('id').nodeValue;

                html += '<div class="responsive" id="' + imageId + '">'
                html += '<div class="gallery">'

                if(includeLinks)
				{
                    html += '<a href="/image/' + imageId + '/">'
	                html += '<img src="' + attr.getNamedItem('thumbUrl'+thumbnailSize).nodeValue + '">';
                    html += '</a>';
				} else {
	                html += '<img onclick = "{{imageOnclickFunction}}" src="' + attr.getNamedItem('thumbUrl'+thumbnailSize).nodeValue + '">';
				}

                questionLink = '/image/' + imageId + '/question/';
                html += '<div class="desc">'
                //TODO: Make these <a> links an image icon instead of the placeholder text link that is here now.
                html += '<a style="cursor: pointer" class="hideLink" id="hideButton' + imageId + '">Hide</a>&nbsp;'
                html += '<a href="' + questionLink + '" class="questionLink">Ques</a>&nbsp;'
                html += '<a style="cursor: pointer" onclick="zoomImage(' + imageId + ')">Zoom</a>'
                html += '</div>';
                html += '</div>';
                html += '</div>';

                offset += 1;
            }

            $('#imageGalleryLoadingMessage').remove();
            $('#imageGalleryDiv').append(html);
            if(!firstLoadOfGallery)
                $('#newResultsDivider')[0].scrollIntoView({block: 'start', inline: 'start'});

            $(".hideLink").click(function()
            {
                $(this).parent().parent().parent().remove();
            });

            $(document).trigger('imageTableLoadEvent');

            loadingInProgress = false;
            firstLoadOfGallery = false;
        });
    }
};

function clearImageGalleryResults()
{
    offset = 0;
    lastParamString = '';
    $('.responsive').remove();
};

function handleWindowResize()
{
    //NOTE: These width values should match the ones in style.css  If that changes need to change these too.
    width = $(window).width();
    if(width > 1000) { numCols = 4; numRows = 2; }
    else if(width > 700) { numCols = 3; numRows = 3; }
    else if(width > 400) { numCols = 2; numRows = 4; }
    else { numCols = 1; numRows = 8; }
};

$(document).ready(initImageGallery);

</script>

<div id=imageGalleryQueryDiv>
    <p>Query Parameters</p>

    <div id=imageGalleryQueriesDiv></div>

    <!-- TODO: Add functionality to set the limit and order of the returned results. (and maybe offset?) -->
    <br>
    <input type=button class=button value="Query Help" onclick="queryHelp()">
    <input type=button class=button value="Add Query Filter" onclick="addQueryParameter()">
    <input type=button class=button value="Load More" onclick="loadImageGalleryResults()">
    <input type=button class=button value="Clear Results" onclick="clearImageGalleryResults()">
</div>

<div id=imageGalleryDiv></div>

<div class="clearfix"></div>

<div style="text-align:center;">
    <input id=loadMoreButton type=button class=button value="Load more" onclick="loadImageGalleryResults()">
</div>

