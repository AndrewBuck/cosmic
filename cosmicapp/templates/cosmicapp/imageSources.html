{% extends "cosmicapp/base.html" %}
{% load static %}

{% block extratitle %} - Image {{id}} sources viewer {% endblock %}

{% block extrahead %}

    <script src="/static/cosmicapp/math.min.js" type="text/javascript"></script>

    {% comment %}
    <link rel="stylesheet" href="http://cdn.pydata.org/bokeh/release/bokeh-0.12.9.min.css">
    <script src="http://cdn.pydata.org/bokeh/release/bokeh-0.12.9.min.js"></script>
    <script src="http://cdn.pydata.org/bokeh/release/bokeh-api-0.12.9.min.js"></script>
    {% endcomment %}
    <link rel="stylesheet" href="/static/cosmicapp/bokeh-0.12.9.min.css">
    <script src="/static/cosmicapp/bokeh-0.12.9.min.js"></script>
    <script src="/static/cosmicapp/bokeh-api-0.12.9.min.js"></script>

{% endblock %}

{% block mainbody %}

{% include "./jquery.html" %}

<table border=2px style="border-collapse: collapse; margin: 1em;">
<tr>
<!-- TODO: Color this top row of cells the color of the given method color.  Since these
colors are defined in javascript, we need to do this in the window.onload function. -->
<th></th>
<th>Lock</th>
<th width=200 id=sextractorTableHeader>Sextractor<div id=sextractorLoadingDiv></div></th>
<th width=200 id=image2xyTableHeader>Image2xy<div id=image2xyLoadingDiv></div></th>
<th width=200 id=daofindTableHeader>Daofind<div id=daofindLoadingDiv></div></th>
<th width=200 id=starfindTableHeader>Starfind<div id=starfindLoadingDiv></div></th>
<th width=200 id=sourceFindMatchesTableHeader>Multiple Matches<div id=sourceFindMatchesLoadingDiv><br><br>Waiting...</div></th>
</tr>

<!-- TODO: Add a row at the top here showing how many results there are from each detection method -->

<tr>
<td>Enabled:</td>
<td align=center><input type=checkbox id=methodEnabledLockCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='sextractorResults'><input type=checkbox id=sextractorEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='image2xyResults'><input type=checkbox id=image2xyEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='daofindResults'><input type=checkbox id=daofindEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='starfindResults'><input type=checkbox id=starfindEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='sourceFindMatchesResults'><input type=checkbox id=sourceFindMatchesEnabledCheckbox onchange="updateTable(this.id)" checked></td>
</tr>

<tr>
<td>Size:</td>
<td align=center><input type=checkbox id=methodSizeLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xySizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td>Size scale:</td>
<td align=center><input type=checkbox id=methodSizeScaleLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xySizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td>Label thresh:</td>
<td align=center><input type=checkbox id=methodLabelThresholdLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xyLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td>Label size:</td>
<td align=center><input type=checkbox id=methodLabelSizeLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xyLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td colspan=2>Label:</td>
    <td class='sextractorResults'>
    <!-- TODO: Add x and y pixel values as options for labels. -->
    <input type=checkbox id=sextractorLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=sextractorLabelFluxErr onchange="drawSources()"> Flux Err<br>
    <input type=checkbox id=sextractorLabelFlags onchange="drawSources()"> Flags<br>
    <input type=checkbox id=sextractorLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='image2xyResults'>
    <input type=checkbox id=image2xyLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=image2xyLabelBackground onchange="drawSources()"> Background<br>
    <input type=checkbox id=image2xyLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='daofindResults'>
    <input type=checkbox id=daofindLabelMag onchange="drawSources()"> Magnitude<br>
    <input type=checkbox id=daofindLabelPeak onchange="drawSources()"> Peak<br>
    <input type=checkbox id=daofindLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=daofindLabelSharpness onchange="drawSources()"> Sharpness<br>
    <input type=checkbox id=daofindLabelSRound onchange="drawSources()"> Sym roundness<br>
    <input type=checkbox id=daofindLabelGRound onchange="drawSources()"> Gauss roundess<br>
    <input type=checkbox id=daofindLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='starfindResults'>
    <input type=checkbox id=starfindLabelMag onchange="drawSources()"> Magnitude<br>
    <input type=checkbox id=starfindLabelPeak onchange="drawSources()"> Peak<br>
    <input type=checkbox id=starfindLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=starfindLabelFWHM onchange="drawSources()"> FWHM<br>
    <input type=checkbox id=starfindLabelRoundness onchange="drawSources()"> Roundness<br>
    <input type=checkbox id=starfindLabelPA onchange="drawSources()"> PA<br>
    <input type=checkbox id=starfindLabelSharpness onchange="drawSources()"> Sharpness<br>
    <input type=checkbox id=starfindLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='sourceFindMatchesResults'>
    <input type=checkbox id=sourceFindMatchesLabelNum onchange="drawSources()" checked> Num Methods<br>
    <input type=checkbox id=sourceFindMatchesLabelConfidence onchange="drawSources()"> Confidence
    </td>
</tr>

<tr>
<td colspan=2>How did<br>we do:</td>
<td align=center class='sextractorResults'>
    <div id=sextractorFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('sextractor')"><br><br>
    </div>

    <div id=sextractorButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('sextractor', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('sextractor', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('sextractor', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('sextractor', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('sextractor', 'wayTooFew')">
    </div>
</td>

<td align=center class='image2xyResults'>
    <div id=image2xyFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('image2xy')"><br><br>
    </div>

    <div id=image2xyButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('image2xy', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('image2xy', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('image2xy', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('image2xy', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('image2xy', 'wayTooFew')">
    </div>
</td>

<td align=center class='daofindResults'>
    <div id=daofindFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('daofind')"><br><br>
    </div>

    <div id=daofindButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('daofind', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('daofind', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('daofind', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('daofind', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('daofind', 'wayTooFew')">
    </div>
</td>

<td align=center class='starfindResults'>
    <div id=starfindFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('starfind')"><br><br>
    </div>

    <div id=starfindButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('starfind', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('starfind', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('starfind', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('starfind', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('starfind', 'wayTooFew')">
    </div>
</td>

</tr>
</table>

<p><div id=uploadResultsDiv>
    Move your mouse over the image to examine the detected sources.  If there are dim
    stars that were not detected by the automatic search routines you can mark a few of
    them yourself.  Left click and hold the mouse button to carefully center on a star and
    then release the mouse button.  You only need to mark 5 to 10 stars manually in any given
    image, however, you should mark some of the <i>dimmest</i> stars you can
    <i>reliably</i> see.  After you have marked some dim stars we can then re-calibrate
    the detection algorithms to the stars you marked and re-run them to automatically mark
    all the rest.
    <br><br>
    <div id=uploadResultsButtonDiv>
        You have marked <div id=uploadResultsNumDiv style="display: inline-block">0</div> of the <i>dimmest</i> stars
        you can <i>reliably</i> see in the image below:
        <input id=uploadMarkedStarsButton type=button value="Upload marked objects." onclick="submitUserResults()">
        <br>
        You have also marked
        <div style="display: inline-block" id=hotPixelsNumDiv>0</div> hot pixels (<i>ctrl</i>),
        <div style="display: inline-block" id=hotLinesNumDiv>0</div> bad lines (<i>ctrl + x</i>), and
        <div style="display: inline-block" id=hotColumnsNumDiv>0</div> bad columns (<i>ctrl + c</i>).
    </div>
</div></p>

<input type=button class=button value="-" onclick="adjustSliderValue('objectsLimitingMagSlider', -1)">
<input type=button class=button value="+" onclick="adjustSliderValue('objectsLimitingMagSlider', 1)">
<input id="objectsLimitingMagSlider" type=range min="0" max="160" value="140" onchange="drawSources()" oninput="drawSources()">
<input type=checkbox id=objectsEnabledCheckbox checked>
<div id=objectsLimitingMagDiv style="display: inline-block"></div>
<br>

<canvas id="sourcesCanvas" width="{{image.dimX}}" height="{{image.dimY}}" style="border:4px solid #00A030">
Your browser does not support the HTML5 canvas tag.
</canvas>

<div id=bokehPlotDiv>
</div>

<script>
var imageId = {{id}};
var limitPerSource = 1000;  //TODO: Add a notice in each of the loading methods if the number returned equals this limit.
var objectsInImage = [];
var sextractorResults = [], image2xyResults = [], daofindResults = [], starfindResults = [];
var userCreatedResults = [], userSubmittedResults = [];
var userCreatedHotPixels = [], userSubmittedHotPixels = [];
var sextractorResultsPromise, image2xyResultsPromise, daofindResultsPromise, starfindResultsPromise;
var sourceFindMatches = [];
var finishedLoading = false;
var submitButtonEnabled = false;
var canvas, context;
var img;
var objectsColor = "#9df909";
var sextractorColor = "#E02010";
var image2xyColor = "#14D3FF";
var daofindColor = "#30A010";
var starfindColor = "#7199E2";
var sourceFindMatchesColor = "#F99740";
var userCreatedColor = "#fff766";
var numberOfBins = 10;
var mouseX = 0;
var mouseY = 0;
var mouseObjectsList = [];
var mouseXStart = -1;
var mouseYStart = -1;
var lmbDown = false;
var reticlePrecision = 0.66;
var mouseoverTextActive = false;
var oldMouseCursor = document.body.style.cursor;
var maxDistanceFromStar = 10;
var mouseTextHideDistance = 120;
var maxDistanceFromStarSquared = maxDistanceFromStar*maxDistanceFromStar;
var lastDrawSourcesTime = 0;
var feedbackSubmittedDict = {'sextractor': false, 'image2xy': false, 'daofind': false, 'starfind': false}

var plot;

var keyCodeDict = {
    17: 'ctrl',
    16: 'shift',
    67: 'c',
    88: 'x',
    90: 'z'
    }

var keyStatusDict = {
    'ctrl': false,
    'shift': false,
    'c': false,
    'x': false,
    'z': false
    }

var numKeysPressed = 0;
var mode = '';

function adjustSliderValue(sliderSelector, increment)
{
    var slider = document.getElementById(sliderSelector);
    slider.value = Number(slider.value) + Number(increment);
};

function drawStroked(c, text, x, y, ignoreDistance=false)
{
    if(!ignoreDistance)
    {
        var deltaX = x - mouseX;
        var deltaY = {{image.dimY}} - y - mouseY;

        if(deltaX*deltaX + deltaY*deltaY < mouseTextHideDistance*mouseTextHideDistance)
            return;
    }

    oldLineWidth = c.lineWidth;
    oldStrokeStyle = c.strokeStyle;
    oldLineJoin = c.lineJoin;
    oldMiterLimit = c.miterLimit;

    c.lineWidth = 4;
    c.strokeStyle = 'black';
    c.lineJoin="miter"; //Experiment with "bevel" & "round" for the effect you want!
    c.miterLimit=2;

    c.strokeText(text, x, y);
    c.fillText(text, x, y);

    c.lineWidth = oldLineWidth;
    c.strokeStyle = oldStrokeStyle;
    c.lineJoin = oldLineJoin;
    c.miterLimit = oldMiterLimit;
};

function getObjectById(objectList, id)
{
    if(id == null)
        return null;

    for(index = 0; index < objectList.length; index++)
    {
        if(objectList[index].id == id)
            return objectList[index];
    }

    return null;
};

function binData(data, nBins)
{
    var i;

    if(data.length == 0)
        return null;

    // Caluculate the range of the input data.
    min = data[0], max = data[0];
    for(i = 0; i < data.length; i++)
    {
        if(data[i] < min)
            min = data[i];

        if(data[i] > max)
            max = data[i];
    }

    // Create the empty bins
    binSize = (max - min)/nBins;
    bins = [[], []];
    for(i = 0; i < nBins; i++)
    {
        bins[0][i] = min + i*binSize;
        bins[1][i] = 0;
    }

    // Loop over the data and sort it into bins.
    for(i = 0; i < data.length; i++)
    {
        binNumber = math.floor((data[i] - min)/binSize);
        binNumber = math.min(binNumber, nBins-1);
        bins[1][binNumber]++;
    }

    return bins;
};

function addHistogramToPlot(data, nBins, lineColor, legendStr, dashArray)
{
    bins = binData(data, nBins);
    if(bins == null)
        return

    dataSource = new Bokeh.ColumnDataSource({
        data: {
        x: bins[0],
        y: bins[1]
        } });

    l = bins[0].slice(0, bins[0].length);
    r = bins[0].slice(1, bins[0].length);
    r.push(2*bins[0][bins[0].length] - bins[0][bins[0].length]);
    t = bins[1];
    b = 0;

    quad = plot.quad(l, r, b, t, {
        line_color: '#000000',
        fill_color: lineColor,
        fill_alpha: 0.25,
        line_width: 2,
        line_dash: dashArray,
        legend: legendStr
        });

    // Hack to force a window resize event which makes the plot properly draw the axis labels.
    window.dispatchEvent(new Event('resize'));

    /*
    oldXRange = plot.x_range;
    oldYRange = plot.y_range;

    plot.x_range.start = math.min(oldXRange.start, bins[0][0]);
    plot.x_range.end = math.max(oldXRange.end, bins[0][bins[0].length-1]);
    plot.y_range.start = -1;
    plot.y_range.end = 100;   //TODO: Set this to the max value of any of the bin counts in the current dataset or the previous max.
    */

    //plot.legend[0].location = "top_left";
    //plot.legend[0].click_policy="hide";

    return quad;
};

function getObjectsInImage()
{
    var i, j;

    $.ajax({
        url : "/query/?queryfor=objectsInImage&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            typeArray = [
                ['TwoMassXSCRecord', 'TwoMassXSC'],
                ['MessierRecord', 'Messier'],
                ['GCVSRecord', 'GCVS'],
                ['AsteroidEphemerisShortRecord', 'Asteroid'],
                ['ExoplanetRecord', 'Exoplanet'],
                ['UCAC4Record', 'UCAC4']
                ]

            for(j = 0; j < typeArray.length; j++)
            {
                var recordType = typeArray[j][0];
                var catalog = typeArray[j][1];
                var results = xml.getElementsByTagName(recordType)

                for(i = 0; i < results.length; i++)
                {
                    var attr = results[i].attributes;

                    switch(recordType)
                    {
                        case 'TwoMassXSCRecord':     mag = Number(attr.getNamedItem('isophotalKMag').nodeValue);    break;
                        case 'MessierRecord':        mag = Number(attr.getNamedItem('magV').nodeValue);             break;
                        case 'GCVSRecord':           mag = Number(attr.getNamedItem('magMax').nodeValue);           break;
                        case 'AsteroidEphemerisShortRecord':     mag = Number(attr.getNamedItem('mag').nodeValue);  break;
                        case 'ExoplanetRecord':      mag = Number(attr.getNamedItem('magV').nodeValue);             break;
                        case 'UCAC4Record':          mag = Number(attr.getNamedItem('magAperture').nodeValue);      break;
                    }

                    objectsInImage[objectsInImage.length] = new Object({
                        catalog: catalog,
                        id: Number(attr.getNamedItem('id').nodeValue),
                        identifier: attr.getNamedItem('identifier').nodeValue,
                        mag: mag,
                        ra: Number(attr.getNamedItem('ra').nodeValue),
                        dec: Number(attr.getNamedItem('dec').nodeValue),
                        x: Number(attr.getNamedItem('pixelX').nodeValue),
                        y: Number(attr.getNamedItem('pixelY').nodeValue),
                    });
                }
            }

            drawSources();
        }
    });
};

function getSextractorResults()
{
    var i;
    $('#sextractorLoadingDiv').html('<br><br>Loading...');

    sextractorResultsPromise = $.ajax({
        url : "/query/?queryfor=sextractorResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            fluxAutoValues = [];
            magAutoValues = [];

            var results = xml.getElementsByTagName('SextractorResult')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;
                sextractorResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    fluxAuto: Number(attr.getNamedItem('fluxAuto').nodeValue),
                    fluxAutoErr: Number(attr.getNamedItem('fluxAutoErr').nodeValue),
                    flags: Number(attr.getNamedItem('flags').nodeValue),
                    boxXMin: Number(attr.getNamedItem('boxXMin').nodeValue),
                    boxYMin: Number(attr.getNamedItem('boxYMin').nodeValue),
                    boxXMax: Number(attr.getNamedItem('boxXMax').nodeValue),
                    boxYMax: Number(attr.getNamedItem('boxYMax').nodeValue)
                });

                //TODO:  Add confidence for this and other types to the bokeh histogram plot.
                fluxAutoValues[i] = sextractorResults[i].fluxAuto;
                magAutoValues[i] = -2.5*math.log10(sextractorResults[i].fluxAuto);
            }

            //addHistogramToPlot(fluxAutoValues, numberOfBins, sextractorColor, 'Flux (sextractor)', []);
            addHistogramToPlot(magAutoValues, numberOfBins, sextractorColor, 'Mag (sextractor)', []);

            drawSources();
            $('#sextractorLoadingDiv').html("<br>" + sextractorResults.length + " Results<br>Loaded");
            $('#sextractorTableHeader').attr('bgcolor', sextractorColor);
            Promise.resolve(true);
        }
    });
};

function getUserSubmittedResults()
{
    var i;

    $.ajax({
        url : "/query/?queryfor=userSubmittedResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            var results = xml.getElementsByTagName('UserSubmittedResult')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;
                userSubmittedResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                });
            }

            drawSources();
        }
    });
};

function getUserSubmittedHotPixels()
{
    var i;

    $.ajax({
        url : "/query/?queryfor=userSubmittedHotPixel&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            var results = xml.getElementsByTagName('UserSubmittedHotPixel')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;
                userSubmittedHotPixels[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                });
            }

            drawSources();
        }
    });
};

function getImage2xyResults()
{
    var i;

    $('#image2xyLoadingDiv').html('<br><br>Loading...');

    image2xyResultsPromise = $.ajax({
        url : "/query/?queryfor=image2xyResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            fluxValues = [];
            magValues = [];
            backgroundValues = [];

            var results = xml.getElementsByTagName('Image2xyResult')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;
                image2xyResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    flux: Number(attr.getNamedItem('flux').nodeValue),
                    background: Number(attr.getNamedItem('background').nodeValue),
                });

                //TODO:  Add confidence for this and other types to the bokeh histogram plot.
                fluxValues[i] = image2xyResults[i].flux;
                magValues[i] = -2.5*math.log10(image2xyResults[i].flux);
            }

            //addHistogramToPlot(fluxValues, numberOfBins, image2xyColor, 'Flux (image2xy)', []);
            addHistogramToPlot(magValues, numberOfBins, image2xyColor, 'Mag (image2xy)', []);

            drawSources();
            $('#image2xyLoadingDiv').html("<br>" + image2xyResults.length + " Results<br>Loaded");
            $('#image2xyTableHeader').attr('bgcolor', image2xyColor);
            Promise.resolve(true);
        }
    });
};

function getDaofindResults()
{
    var i;

    $('#daofindLoadingDiv').html('<br><br>Loading...');

    daofindResultsPromise = $.ajax({
        url : "/query/?queryfor=daofindResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            magValues = [];
            //fluxValues = [];
            //peakValues = [];
            //sharpnessValues = [];
            //sroundValues = [];
            //groundValues = [];

            var results = xml.getElementsByTagName('DaofindResult')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;
                daofindResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    mag: Number(attr.getNamedItem('mag').nodeValue),
                    flux: Number(attr.getNamedItem('flux').nodeValue),
                    peak: Number(attr.getNamedItem('peak').nodeValue),
                    sharpness: Number(attr.getNamedItem('sharpness').nodeValue),
                    sround: Number(attr.getNamedItem('sround').nodeValue),
                    ground: Number(attr.getNamedItem('ground').nodeValue)
                });

                magValues[i] = daofindResults[i].mag;
                //fluxValues[i] = daofindResults[i].flux;
                //peakValues[i] = daofindResults[i].peak;
                //sharpnessValues[i] = daofindResults[i].sharpness;
                //sroundValues[i] = daofindResults[i].sround;
                //groundValues[i] = daofindResults[i].ground;
            }

            addHistogramToPlot(magValues, numberOfBins, daofindColor, 'Mag (daofind)', []);
            //addHistogramToPlot(fluxValues, numberOfBins, daofindColor, 'Flux (daofind)', [1, 3]);
            //addHistogramToPlot(peakValues, numberOfBins, daofindColor, 'Peak(daofind)', [1, 3, 3, 5]);
            //addHistogramToPlot(sharpnessValues, numberOfBins, daofindColor, 'Sharpness (daofind)', [3, 3]);
            //addHistogramToPlot(sroundValues, numberOfBins, daofindColor, 'S Round (daofind)', [3, 6]);
            //addHistogramToPlot(groundValues, numberOfBins, daofindColor, 'G Round (daofind)', [6, 6]);

            drawSources();
            $('#daofindLoadingDiv').html("<br>" + daofindResults.length + " Results<br>Loaded");
            $('#daofindTableHeader').attr('bgcolor', daofindColor);
            Promise.resolve(true);
        }
    });
};

function getStarfindResults()
{
    var i;

    $('#starfindLoadingDiv').html('<br><br>Loading...');

    starfindResultsPromise = $.ajax({
        url : "/query/?queryfor=starfindResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            magValues = [];
            //peakValues = [];
            //fluxValues = [];
            //fwhmValues = [];
            //roundnessValues = [];
            //paValues = [];
            //sharpnessValues = [];

            var results = xml.getElementsByTagName('StarfindResult')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;
                starfindResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    mag: Number(attr.getNamedItem('mag').nodeValue),
                    peak: Number(attr.getNamedItem('peak').nodeValue),
                    flux: Number(attr.getNamedItem('flux').nodeValue),
                    fwhm: Number(attr.getNamedItem('fwhm').nodeValue),
                    roundness: Number(attr.getNamedItem('roundness').nodeValue),
                    pa: Number(attr.getNamedItem('pa').nodeValue),
                    sharpness: Number(attr.getNamedItem('sharpness').nodeValue)
                });

                magValues[i] = starfindResults[i].mag;
                //peakValues[i] = starfindResults[i].peak;
                //fluxValues[i] = starfindResults[i].flux;
                //fwhmValues[i] = starfindResults[i].fwhm;
                //roundnessValues[i] = starfindResults[i].roundness;
                //paValues[i] = starfindResults[i].pa;
                //sharpnessValues[i] = starfindResults[i].sharpness;
            }

            addHistogramToPlot(magValues, numberOfBins, starfindColor, 'Mag (starfind)', []);
            //addHistogramToPlot(peakValues, numberOfBins, starfindColor, 'Peak (starfind)', [1, 3]);
            //addHistogramToPlot(fluxValues, numberOfBins, starfindColor, 'Flux (starfind)', [1, 3, 3, 5]);
            //addHistogramToPlot(fwhmValues, numberOfBins, starfindColor, 'FWHM (starfind)', [3, 6]);
            //addHistogramToPlot(roundnessValues, numberOfBins, starfindColor, 'Roundness (starfind)', [6, 6]);
            //addHistogramToPlot(paValues, numberOfBins, starfindColor, 'PA (starfind)', [2, 2, 5]);
            //addHistogramToPlot(sharpnessValues, numberOfBins, starfindColor, 'Sharpness (starfind)', [2, 2, 2, 2, 5]);

            drawSources();
            $('#starfindLoadingDiv').html("<br>" + starfindResults.length + " Results<br>Loaded");
            $('#starfindTableHeader').attr('bgcolor', starfindColor);
            Promise.resolve(true);
        }
    });
};

function getSourceFindMatches()
{
    var i;

    $('#sourceFindMatchesLoadingDiv').html('<br><br>Loading...');

    $.ajax({
        url : "/query/?queryfor=sourceFindMatch&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            var results = xml.getElementsByTagName('SourceFindMatch')
            for(i = 0; i < results.length; i++)
            {
                var attr = results[i].attributes;

                sextractorId = null, image2xyId = null, daofindId = null, starfindId = null, userSubmittedId = null;
                if(attr.getNamedItem('sextractorResult') != null)
                    sextractorId = Number(attr.getNamedItem('sextractorResult').nodeValue);

                if(attr.getNamedItem('image2xyResult') != null)
                    image2xyId = Number(attr.getNamedItem('image2xyResult').nodeValue);

                if(attr.getNamedItem('daofindResult') != null)
                    daofindId = Number(attr.getNamedItem('daofindResult').nodeValue);

                if(attr.getNamedItem('starfindResult') != null)
                    starfindId = Number(attr.getNamedItem('starfindResult').nodeValue);

                if(attr.getNamedItem('userSubmittedResult') != null)
                    userSubmittedId = Number(attr.getNamedItem('userSubmittedResult').nodeValue);

                sourceFindMatches[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    confidence: Number(attr.getNamedItem('confidence').nodeValue),
                    numMatches: Number(attr.getNamedItem('numMatches').nodeValue),
                    ra: Number(attr.getNamedItem('ra').nodeValue),
                    dec: Number(attr.getNamedItem('dec').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    sextractorResultId: sextractorId,
                    image2xyResultId: image2xyId,
                    daofindResultId: daofindId,
                    starfindResultId: starfindId,
                    userSubmittedResultId: userSubmittedId
                });

                //TODO: Since this code depends on accessing other objects we will need to break it out into a function
                //and call it again every time new objects are added to the lists.
                sourceFindMatches[i].sextractorResult = getObjectById(sextractorResults, sourceFindMatches[i].sextractorResultId);
                sourceFindMatches[i].image2xyResult = getObjectById(image2xyResults, sourceFindMatches[i].image2xyResultId);
                sourceFindMatches[i].daofindResult = getObjectById(daofindResults, sourceFindMatches[i].daofindResultId);
                sourceFindMatches[i].starfindResult = getObjectById(starfindResults, sourceFindMatches[i].starfindResultId);
                sourceFindMatches[i].userSubmittedResult = getObjectById(userSubmittedResults, sourceFindMatches[i].userSubmittedResultId);
            }

            finishedLoading = true;
            drawSources();
            $('#sourceFindMatchesLoadingDiv').html("<br>" + sourceFindMatches.length + " Results<br>Loaded");
            $('#sourceFindMatchesTableHeader').attr('bgcolor', sourceFindMatchesColor);
            Promise.resolve(true);
        }
    });
};

function submitUserResults()
{
    var i;
    var commaString;

    $.ajax({
        url : "/save/userSubmittedSourceResults/",
        type : "post",
        data: {userResults: JSON.stringify(userCreatedResults), hotPixels: JSON.stringify(userCreatedHotPixels), imageId: imageId},
        dataType: 'json',
        success : function(response)
        {
            alert(response.text);

            userCreatedResults = [];
            userSubmittedResults = [];
            getUserSubmittedResults();

            userCreatedHotPixels = [];
            userSubmittedHotPixels = [];
            getUserSubmittedHotPixels();
        }
        //TODO: Implement error handler.
    });
};

function feedbackButtonClicked(method)
{
    $('#methodEnabledLockCheckbox').prop('checked', false)
    $('#sextractorEnabledCheckbox').prop('checked', false)
    $('#image2xyEnabledCheckbox').prop('checked', false)
    $('#daofindEnabledCheckbox').prop('checked', false)
    $('#starfindEnabledCheckbox').prop('checked', false)
    $('#sourceFindMatchesEnabledCheckbox').prop('checked', false)

    $('#' + method + 'EnabledCheckbox').prop('checked', true)

    updateTable('feedbackButton');

    $('#' + method + 'FeedbackButtonDiv').hide();
    $('#' + method + 'ButtonDiv').show();

    $('#sourcesCanvas')[0].scrollIntoView({behaviour: 'smooth', block: 'start', inline: 'start'});
};

function submitUserFeedback(method, feedback)
{
    $('#' + method + 'ButtonDiv').fadeOut(0);
    if(feedback == 'aboutRight')
        $('#' + method + 'ButtonDiv').html("Thank you.  We will use this to guide the refinement of the other source detection algorithms for this image.");
    else
        $('#' + method + 'ButtonDiv').html("Thank you.  New results will be available in a minute or two.");
    $('#' + method + 'ButtonDiv').fadeIn(2000);

    $.ajax({
        url : "/save/userSubmittedFeedback/",
        type : "post",
        data: {method: method, feedback, feedback, imageId: imageId},
        dataType: 'json',
        success : function(response)
        {
            alert(response.text);

            feedbackSubmittedDict[method] = true;
            for(otherMethod in feedbackSubmittedDict)
            {
                if(otherMethod == method)
                    continue;

                switch(method)
                {
                    case 'sextractor':   theseResults = sextractorResults;   break;
                    case 'image2xy':     theseResults = image2xyResults;     break;
                    case 'daofind':      theseResults = daofindResults;      break;
                    case 'starfind':     theseResults = starfindResults;     break;
                }

                switch(otherMethod)
                {
                    case 'sextractor':   results = sextractorResults;   break;
                    case 'image2xy':     results = image2xyResults;     break;
                    case 'daofind':      results = daofindResults;      break;
                    case 'starfind':     results = starfindResults;     break;
                }

                if(feedback == 'tooMany')
                    if(results.length > theseResults.length)
                    {
                        feedbackSubmittedDict[otherMethod] = true;
                        $('#' + otherMethod + 'FeedbackButtonDiv').hide();
                        $('#' + otherMethod + 'ButtonDiv').fadeOut(0);
                        $('#' + otherMethod + 'ButtonDiv').html("There are even more results on this method.");
                        $('#' + otherMethod + 'ButtonDiv').fadeIn(5000);
                    }

                if(feedback == 'tooFew')
                    if(results.length < theseResults.length)
                    {
                        feedbackSubmittedDict[otherMethod] = true;
                        $('#' + otherMethod + 'FeedbackButtonDiv').hide();
                        $('#' + otherMethod + 'ButtonDiv').fadeOut(0);
                        $('#' + otherMethod + 'ButtonDiv').html("There are even fewer results on this method.");
                        $('#' + otherMethod + 'ButtonDiv').fadeIn(5000);
                    }

                if(feedback == 'aboutRight')
                {
                    feedbackSubmittedDict[otherMethod] = true;
                    $('#' + otherMethod + 'FeedbackButtonDiv').hide();
                    $('#' + otherMethod + 'ButtonDiv').fadeOut(0);
                    $('#' + otherMethod + 'ButtonDiv').html("Done.");
                    $('#' + otherMethod + 'ButtonDiv').fadeIn(5000);
                }
            }
        }
        //TODO: Implement error handler.
    });

};

function constructLabelText(paramArray)
{
    var i;
    var labelArray = [];
    var id, value, round;
    for(i = 0; i < paramArray.length; i++)
    {
        id = paramArray[i][0];
        value = paramArray[i][1];
        round = paramArray[i][2];

        if($(id).is(':checked'))
            labelArray[i] = math.round(value, round);
    }

    return labelArray.join(' ');
};

function drawSource(c, x, y, size, sizeFactor, sizeScaleFactor, boxXMin=undefined, boxYMin=undefined, boxXMax=undefined, boxYMax=undefined)
{
    var oldGlobalAlpha = c.globalAlpha;

    var deltaX = x - mouseX;
    var deltaY = y - mouseY;

    var dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
    var multiplier = 15;
    if(dist < maxDistanceFromStar)
        return;

    if(dist < multiplier*maxDistanceFromStar)
        context.globalAlpha = Math.max(0.2, Math.pow(dist/(multiplier*maxDistanceFromStar), 3));

    var drawRadius = sizeFactor*Math.pow(size, sizeScaleFactor);
    drawRadius = math.min(drawRadius, 20);
    drawRadius = math.max(drawRadius, 2);

    c.beginPath();
    c.arc(x, {{image.dimY}} - y, drawRadius, 0, 2*Math.PI)
    c.stroke();

    if(!(boxYMax === undefined))
    {
        if(math.abs(boxXMax-boxXMin) > 8 && math.abs(boxYMax-boxYMin) > 8)
        {
            c.beginPath();
            c.rect(boxXMin, {{image.dimY}} - boxYMin, boxXMax-boxXMin, boxYMin-boxYMax);
            c.stroke();
        }
    }

    context.globalAlpha = oldGlobalAlpha;
};

function drawHLine(c, y, color='#A02020', opacity=-1)
{
    var oldGlobalAlpha = c.globalAlpha;
    var oldStrokeStyle = c.strokeStyle;
    var oldFillStyle = c.fillStyle;
    c.strokeStyle = color;
    c.fillStyle = color;

    if(opacity == -1)
        c.globalAlpha = 0.2;
    else
        c.globalAlpha = opacity;

    c.beginPath();
    c.moveTo(0, {{image.dimY}} - y);
    c.lineTo({{image.dimX}}, {{image.dimY}} - y);
    c.stroke();

    c.strokeStyle = oldStrokeStyle;
    c.fillStyle = oldFillStyle;
    context.globalAlpha = oldGlobalAlpha;
};

function drawVLine(c, x, color='#A02020', opacity=-1)
{
    var oldGlobalAlpha = c.globalAlpha;
    var oldStrokeStyle = c.strokeStyle;
    var oldFillStyle = c.fillStyle;
    c.strokeStyle = color;
    c.fillStyle = color;

    if(opacity == -1)
        c.globalAlpha = 0.2;
    else
        c.globalAlpha = opacity;

    c.beginPath();
    c.moveTo(x, 0);
    c.lineTo(x, {{image.dimY}});
    c.stroke();

    c.strokeStyle = oldStrokeStyle;
    c.fillStyle = oldFillStyle;
    context.globalAlpha = oldGlobalAlpha;
};

function drawReticle(c, x, y, size, color='#A02020', opacity=-1)
{
    var oldGlobalAlpha = c.globalAlpha;
    if(opacity == -1)
        c.globalAlpha = 0.4 + 0.6*Math.pow(mouseObjectsList.length/3, 2);
    else
        c.globalAlpha = opacity;

    oldStrokeStyle = c.strokeStyle;
    oldFillStyle = c.fillStyle;
    c.strokeStyle = color;
    c.fillStyle = color;

    var i;
    var angle = Math.PI/8;

    c.beginPath();
    c.arc(x, {{image.dimY}} - y, size, 0, 2*Math.PI)
    c.stroke();

    c.beginPath();
    c.moveTo(x-size*.2, {{image.dimY}} - y);
    c.lineTo(x-size*.66, {{image.dimY}} - y);
    c.stroke();

    c.beginPath();
    c.moveTo(x+size*.2, {{image.dimY}} - y);
    c.lineTo(x+size*.66, {{image.dimY}} - y);
    c.stroke();

    c.beginPath();
    c.moveTo(x, {{image.dimY}} - (y-size*.2));
    c.lineTo(x, {{image.dimY}} - (y-size*.66));
    c.stroke();

    c.beginPath();
    c.moveTo(x, {{image.dimY}} - (y+size*.2));
    c.lineTo(x, {{image.dimY}} - (y+size*.66));
    c.stroke();

    for(i = 0; i < 4; i++)
    {
        c.beginPath();
        c.arc(x, {{image.dimY}} - y, size*.66, i*Math.PI/2-angle, i*Math.PI/2+angle)
        c.stroke();
    }

    c.strokeStyle = oldStrokeStyle;
    c.fillStyle = oldFillStyle;
    context.globalAlpha = oldGlobalAlpha;
};

function drawSources()
{
    var i;

    var d = new Date();
    var currentMilliseconds = d.getTime();
    if(currentMilliseconds - lastDrawSourcesTime < 100)
    {
        //TODO: Need to start a timer or something to trigger a redraw after the timeout has expired.
        return;
    }

    lastDrawSourcesTime = currentMilliseconds;

    context.drawImage(img, 0, 0);
    context.lineWidth = 2;

    context.strokeStyle = objectsColor;
    context.fillStyle = objectsColor;
    limitingMag = $('#objectsLimitingMagSlider').val()/10;
    $('#objectsLimitingMagDiv').html("Catalog objects limiting Magnitude: " + limitingMag);
    if($('#objectsEnabledCheckbox').is(':checked'))
    for(i = 0; i < objectsInImage.length && !lmbDown; i++)
    {
        if(objectsInImage[i].mag < limitingMag)
            if(objectsInImage[i].catalog == 'UCAC4')
                drawSource(context, objectsInImage[i].x, objectsInImage[i].y, 2.0, 20-objectsInImage[i].mag, 1.0);
            else
                drawReticle(context, objectsInImage[i].x, objectsInImage[i].y, 30-objectsInImage[i].mag, objectsColor, 1.0);
    }


    context.strokeStyle = sextractorColor;
    context.fillStyle = sextractorColor;

    sizeFactor = $('#sextractorSizeSlider').val();
    sizeScaleFactor = 1 + $('#sextractorSizeScaleSlider').val()/25.0;
    labelThreshold = $('#sextractorLabelThresholdSlider').val()/100.0;
    labelSize= $('#sextractorLabelSizeSlider').val()/5 + 10
    if($('#sextractorEnabledCheckbox').is(':checked'))
    for(i = 0; i < sextractorResults.length && !lmbDown; i++)
    {
        drawSource(context, sextractorResults[i].x, sextractorResults[i].y, sextractorResults[i].confidence, sizeFactor, sizeScaleFactor,
                   sextractorResults[i].boxXMin, sextractorResults[i].boxYMin, sextractorResults[i].boxXMax, sextractorResults[i].boxYMax);

        if(sextractorResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#sextractorLabelFlux', sextractorResults[i].fluxAuto, 2],
                ['#sextractorLabelFluxErr', sextractorResults[i].fluxAutoErr, 2],
                ['#sextractorLabelFlags', sextractorResults[i].flags, 0],
                ['#sextractorLabelConfidence', sextractorResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, sextractorResults[i].x + labelSize/2, {{image.dimY}} - sextractorResults[i].y - labelSize)
        }
    }

    context.strokeStyle = image2xyColor;
    context.fillStyle = image2xyColor;

    sizeFactor = $('#image2xySizeSlider').val();
    sizeScaleFactor = 1.0 + $('#image2xySizeScaleSlider').val()/25.0;
    labelThreshold = $('#image2xyLabelThresholdSlider').val()/100.0;
    labelSize= $('#image2xyLabelSizeSlider').val()/5 + 10
    if($('#image2xyEnabledCheckbox').is(':checked'))
    for(i = 0; i < image2xyResults.length && !lmbDown; i++)
    {
        drawSource(context, image2xyResults[i].x, image2xyResults[i].y, image2xyResults[i].confidence, sizeFactor, sizeScaleFactor);

        if(image2xyResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#image2xyLabelFlux', image2xyResults[i].flux, 2],
                ['#image2xyLabelBackground', image2xyResults[i].background, 2],
                ['#image2xyLabelConfidence', image2xyResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, image2xyResults[i].x + labelSize/2, {{image.dimY}} - image2xyResults[i].y)
        }
    }

    context.strokeStyle = daofindColor;
    context.fillStyle = daofindColor;

    sizeFactor = $('#daofindSizeSlider').val();
    sizeScaleFactor = 1.0 + $('#daofindSizeScaleSlider').val()/25.0;
    labelThreshold = $('#daofindLabelThresholdSlider').val()/100.0;
    labelSize= $('#daofindLabelSizeSlider').val()/5 + 10
    if($('#daofindEnabledCheckbox').is(':checked'))
    for(i = 0; i < daofindResults.length && !lmbDown; i++)
    {
        drawSource(context, daofindResults[i].x, daofindResults[i].y, daofindResults[i].confidence, sizeFactor, sizeScaleFactor);

        if(daofindResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#daofindLabelMag', daofindResults[i].mag, 2],
                ['#daofindLabelPeak', daofindResults[i].peak, 2],
                ['#daofindLabelFlux', daofindResults[i].flux, 2],
                ['#daofindLabelSharpness', daofindResults[i].sharpness, 2],
                ['#daofindLabelSRound', daofindResults[i].sround, 2],
                ['#daofindLabelGRound', daofindResults[i].ground, 2],
                ['#daofindLabelConfidence', daofindResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, daofindResults[i].x + labelSize/2, {{image.dimY}} - daofindResults[i].y + labelSize)
        }
    }

    context.strokeStyle = starfindColor;
    context.fillStyle = starfindColor;

    sizeFactor = $('#starfindSizeSlider').val();
    sizeScaleFactor = 1.0 + $('#starfindSizeScaleSlider').val()/25.0;
    labelThreshold = $('#starfindLabelThresholdSlider').val()/100.0;
    labelSize= $('#starfindLabelSizeSlider').val()/5 + 10
    if($('#starfindEnabledCheckbox').is(':checked'))
    for(i = 0; i < starfindResults.length && !lmbDown; i++)
    {
        drawSource(context, starfindResults[i].x, starfindResults[i].y, starfindResults[i].confidence, sizeFactor, sizeScaleFactor);

        if(starfindResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#starfindLabelMag', starfindResults[i].mag, 2],
                ['#starfindLabelPeak', starfindResults[i].peak, 2],
                ['#starfindLabelFlux', starfindResults[i].flux, 2],
                ['#starfindLabelFWHM', starfindResults[i].fwhm, 2],
                ['#starfindLabelRoundness', starfindResults[i].roundness, 2],
                ['#starfindLabelPA', starfindResults[i].pa, 2],
                ['#starfindLabelSharpness', starfindResults[i].sharpness, 2],
                ['#starfindLabelConfidence', starfindResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, starfindResults[i].x + labelSize/2, {{image.dimY}} - starfindResults[i].y + 2*labelSize)
        }
    }

    context.strokeStyle = sourceFindMatchesColor;
    context.fillStyle = sourceFindMatchesColor;

    sizeFactor = $('#sourceFindMatchesSizeSlider').val();
    sizeScaleFactor = $('#sourceFindMatchesSizeScaleSlider').val()/25.0;
    labelThreshold = $('#sourceFindMatchesLabelThresholdSlider').val()/100.0;
    labelSize= $('#sourceFindMatchesLabelSizeSlider').val()/5 + 10
    if($('#sourceFindMatchesEnabledCheckbox').is(':checked'))
    for(i = 0; i < sourceFindMatches.length && !lmbDown; i++)
    {
        drawSource(context, sourceFindMatches[i].x, sourceFindMatches[i].y, sourceFindMatches[i].confidence, sizeFactor, sizeScaleFactor);

        if(sourceFindMatches[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#sourceFindMatchesLabelNum', sourceFindMatches[i].numMatches, 0],
                ['#sourceFindMatchesLabelConfidence', sourceFindMatches[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            context.textAlign = 'end';
            drawStroked(context, labelText, sourceFindMatches[i].x - labelSize/2, {{image.dimY}} - sourceFindMatches[i].y)
            context.textAlign = 'start';
        }
    }

    context.strokeStyle = userCreatedColor;
    context.fillStyle = userCreatedColor;

    for(i = 0; i < userSubmittedResults.length && !lmbDown; i++)
        drawSource(context, userSubmittedResults[i].x, userSubmittedResults[i].y, 1.0, 10, 2);

    for(i = 0; i < userSubmittedHotPixels.length && !lmbDown; i++)
        drawSource(context, userSubmittedHotPixels[i].x, userSubmittedHotPixels[i].y, 1.0, 5, 2);

    for(i = 0; i < userCreatedResults.length && !lmbDown; i++)
        drawReticle(context, userCreatedResults[i].x, userCreatedResults[i].y, 10, userCreatedColor, 0.8);

    for(i = 0; i < userCreatedHotPixels.length && !lmbDown; i++)
        drawReticle(context, userCreatedHotPixels[i].x, userCreatedHotPixels[i].y, 5, userCreatedColor, 0.8);

    labelSize = 20
    context.font = labelSize + 'px sans-serif'
    if(mouseX > {{image.dimX}} / 2)
    {
        context.textAlign = 'end';
        xPos = mouseX - 50;
    }
    else
    {
        context.textAlign = 'start';
        xPos = mouseX + 50;
    }

    yPos = mouseY - (mouseY/{{image.dimY}})*(mouseObjectsList.length-0)*(labelSize+4) + 30*(1.0-mouseY/{{image.dimY}});

    var raDecPrinted = false;
    for(i = 0; i < mouseObjectsList.length && !lmbDown; i++)
    {
        switch(mouseObjectsList[i].method)
        {
            case 'sextractor':
                context.strokeStyle = sextractorColor;
                context.fillStyle = sextractorColor;
                break;

            case 'image2xy':
                context.strokeStyle = image2xyColor;
                context.fillStyle = image2xyColor;
                break;

            case 'daofind':
                context.strokeStyle = daofindColor;
                context.fillStyle = daofindColor;
                break;

            case 'starfind':
                context.strokeStyle = starfindColor;
                context.fillStyle = starfindColor;
                break;

            case 'multi':
                context.strokeStyle = sourceFindMatchesColor;
                context.fillStyle = sourceFindMatchesColor;
                break;

            case 'user - not uploaded':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'user - hot pixel - not uploaded':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'user - hot pixel':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'user':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'Catalog':
                context.strokeStyle = objectsColor;
                context.fillStyle = objectsColor;
                break;

            default:
                alert("Unhandled case statement for value: " + mouseObjectsList[i].method);
                break;
        }

        if(mouseObjectsList[i].method == 'Catalog')
            drawStroked(context, mouseObjectsList[i].catalog + "  " + mouseObjectsList[i].identifier
                        + "  " + math.round(mouseObjectsList[i].mag, 2), xPos, {{image.dimY}} - yPos - i*(labelSize+4), true);
        else
            drawStroked(context, mouseObjectsList[i].method + " " + math.round(mouseObjectsList[i].confidence, 2),
                        xPos, {{image.dimY}} - yPos - i*(labelSize+4), true);

        if(!raDecPrinted)
        {
            raDecPrinted = true;
            drawStroked(context, "ra dec: " + math.round(mouseObjectsList[i].ra, 3) + "   "
            + math.round(mouseObjectsList[i].dec, 3),
                        xPos, {{image.dimY}} - yPos + (labelSize+4), true);
        }
    }

    if(lmbDown)
    {
        //NOTE: These lines are duplicated elsewhere, if they change the others must too.
        var deltaX = mouseX - mouseXStart;
        var deltaY = mouseY - mouseYStart;
        var xPos = mouseX - reticlePrecision*deltaX;
        var yPos = mouseY - reticlePrecision*deltaY;

        if(mode == 'stars' || mode == 'hotpixels')
            drawReticle(context, xPos, yPos, 30, userCreatedColor, 0.8);
        else if(mode == 'hotlines')
            drawHLine(context, yPos, userCreatedColor, 0.8);
        else if(mode == 'hotcolumns')
            drawVLine(context, xPos, userCreatedColor, 0.8);
    }
    else
    {
        if(mode == 'stars' || mode == 'hotpixels')
        {
            if(mouseoverTextActive)
                drawReticle(context, mouseX, mouseY, 30/reticlePrecision, userCreatedColor, 0.8);
            else
                drawReticle(context, mouseX, mouseY, 30/reticlePrecision, userCreatedColor, 0.4);
        }
        else if(mode == 'hotlines')
            drawHLine(context, mouseY, userCreatedColor, 0.8);
        else if(mode == 'hotcolumns')
            drawVLine(context, mouseX, userCreatedColor, 0.8);
    }

    context.textAlign = 'start';

    if(!finishedLoading)
        drawStroked(context, "Loading...", {{image.dimX}}/2 - 40, {{image.dimY}}/2, true);

    // Log the draw time taken by the routine to the console.
    if(false)
    {
        var d = new Date();
        var endMilliseconds = d.getTime();
        console.log("Draw time: " + (endMilliseconds - currentMilliseconds) + " milliseconds.");
    }
};

function updateTable(id)
{
    var temp;

    switch(id)
    {
        case undefined:
            break;

        case 'feedbackButton':
        case 'sextractorEnabledCheckbox':
        case 'image2xyEnabledCheckbox':
        case 'daofindEnabledCheckbox':
        case 'starfindEnabledCheckbox':
        case 'sourceFindMatchesEnabledCheckbox':
        case 'methodEnabledLockCheckbox':
            if($('#methodEnabledLockCheckbox').is(':checked'))
            {
                if(id != 'methodEnabledLockCheckbox')
                    temp = $('#'+id).is(':checked');
                else
                    temp = $('#sextractorEnabledCheckbox').is(':checked');

                $('#sextractorEnabledCheckbox').prop('checked', temp)
                $('#image2xyEnabledCheckbox').prop('checked', temp)
                $('#daofindEnabledCheckbox').prop('checked', temp)
                $('#starfindEnabledCheckbox').prop('checked', temp)
                $('#sourceFindMatchesEnabledCheckbox').prop('checked', temp)
            }

            for(method in feedbackSubmittedDict)
            {
                if(!feedbackSubmittedDict[method])
                {
                    $('#' + method + 'FeedbackButtonDiv').show();
                    $('#' + method + 'ButtonDiv').hide();
                }
            }

            break;

        case 'sextractorSizeSlider':
        case 'image2xySizeSlider':
        case 'daofindSizeSlider':
        case 'starfindSizeSlider':
        case 'sourceFindMatchesSizeSlider':
        case 'methodSizeLockCheckbox':
            if($('#methodSizeLockCheckbox').is(':checked'))
            {
                if(id != 'methodSizeLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorSizeSlider').prop('value');

                $('#sextractorSizeSlider').prop('value', temp)
                $('#image2xySizeSlider').prop('value', temp)
                $('#daofindSizeSlider').prop('value', temp)
                $('#starfindSizeSlider').prop('value', temp)
                $('#sourceFindMatchesSizeSlider').prop('value', temp)
            }
            break;

        case 'sextractorSizeScaleSlider':
        case 'image2xySizeScaleSlider':
        case 'daofindSizeScaleSlider':
        case 'starfindSizeScaleSlider':
        case 'sourceFindMatchesSizeScaleSlider':
        case 'methodSizeScaleLockCheckbox':
            if($('#methodSizeScaleLockCheckbox').is(':checked'))
            {
                if(id != 'methodSizeScaleLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorSizeScaleSlider').prop('value');

                $('#sextractorSizeScaleSlider').prop('value', temp)
                $('#image2xySizeScaleSlider').prop('value', temp)
                $('#daofindSizeScaleSlider').prop('value', temp)
                $('#starfindSizeScaleSlider').prop('value', temp)
                $('#sourceFindMatchesSizeScaleSlider').prop('value', temp)
            }
            break;

        case 'sextractorLabelThresholdSlider':
        case 'image2xyLabelThresholdSlider':
        case 'daofindLabelThresholdSlider':
        case 'starfindLabelThresholdSlider':
        case 'sourceFindMatchesLabelThresholdSlider':
        case 'methodLabelThresholdLockCheckbox':
            if($('#methodLabelThresholdLockCheckbox').is(':checked'))
            {
                if(id != 'methodLabelThresholdLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorLabelThresholdSlider').prop('value');

                $('#sextractorLabelThresholdSlider').prop('value', temp)
                $('#image2xyLabelThresholdSlider').prop('value', temp)
                $('#daofindLabelThresholdSlider').prop('value', temp)
                $('#starfindLabelThresholdSlider').prop('value', temp)
                $('#sourceFindMatchesLabelThresholdSlider').prop('value', temp)
            }
            break;

        case 'sextractorLabelSizeSlider':
        case 'image2xyLabelSizeSlider':
        case 'daofindLabelSizeSlider':
        case 'starfindLabelSizeSlider':
        case 'sourceFindMatchesLabelSizeSlider':
        case 'methodLabelSizeLockCheckbox':
            if($('#methodLabelSizeLockCheckbox').is(':checked'))
            {
                if(id != 'methodLabelSizeLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorLabelSizeSlider').prop('value');

                $('#sextractorLabelSizeSlider').prop('value', temp)
                $('#image2xyLabelSizeSlider').prop('value', temp)
                $('#daofindLabelSizeSlider').prop('value', temp)
                $('#starfindLabelSizeSlider').prop('value', temp)
                $('#sourceFindMatchesLabelSizeSlider').prop('value', temp)
            }
            break;
    }

    if($('#sextractorEnabledCheckbox').is(':checked'))
        $('.sextractorResults').css('background-color', sextractorColor);
    else
        $('.sextractorResults').css('background-color', 'transparent');

    if($('#image2xyEnabledCheckbox').is(':checked'))
        $('.image2xyResults').css('background-color', image2xyColor);
    else
        $('.image2xyResults').css('background-color', 'transparent');

    if($('#daofindEnabledCheckbox').is(':checked'))
        $('.daofindResults').css('background-color', daofindColor);
    else
        $('.daofindResults').css('background-color', 'transparent');

    if($('#starfindEnabledCheckbox').is(':checked'))
        $('.starfindResults').css('background-color', starfindColor);
    else
        $('.starfindResults').css('background-color', 'transparent');

    if($('#sourceFindMatchesEnabledCheckbox').is(':checked'))
        $('.sourceFindMatchesResults').css('background-color', sourceFindMatchesColor);
    else
        $('.sourceFindMatchesResults').css('background-color', 'transparent');

    drawSources();
};

function arraysEqual(arr1, arr2)
{
    if(arr1.length !== arr2.length)
        return false;
    for(var i = arr1.length; i--;)
    {
        if(arr1[i] !== arr2[i])
            return false;
    }

    return true;
};

function handleMouseMove(event)
{
    var rect = canvas.getBoundingClientRect();

    mouseX = event.clientX - rect.left;
    mouseY = {{image.dimY}} - (event.clientY - rect.top);

    if(!lmbDown && (event.clientX < rect.left || event.clientX >  rect.right || event.clientY < rect.top || event.clientY > rect.bottom))
        return true;

    oldMouseObjectsList = mouseObjectsList;
    mouseObjectsList = [];

    //TODO: Add an if statement for each source and only include it in this array if it is
    //checked up above.
    sourceLists = [];

    if($('#sextractorEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [sextractorResults, 'sextractor'];

    if($('#image2xyEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [image2xyResults, 'image2xy'];
    if($('#daofindEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [daofindResults, 'daofind'];
    if($('#starfindEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [starfindResults, 'starfind'];
    if($('#sourceFindMatchesEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [sourceFindMatches, 'multi'];
    if($('#objectsEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [objectsInImage, 'Catalog'];

    sourceLists[sourceLists.length] = [userCreatedResults, 'user - not uploaded'];
    sourceLists[sourceLists.length] = [userCreatedHotPixels, 'user - hot pixel - not uploaded'];
    sourceLists[sourceLists.length] = [userSubmittedResults, 'user'];
    sourceLists[sourceLists.length] = [userSubmittedHotPixels, 'user - hot pixel'];

    for(var i = 0; i < sourceLists.length; i++)
    {
        currentList = sourceLists[i][0];
        currentMethod = sourceLists[i][1];

        for(var j = 0; j < currentList.length; j++)
        {
            currentSource = sourceLists[i][0][j];
            x = currentSource.x;
            y = currentSource.y;
            deltaX = mouseX - x;
            deltaY = mouseY - y;
            dsq = deltaX*deltaX + deltaY*deltaY;
            if(dsq < maxDistanceFromStarSquared)
            {
                var mouseLength = mouseObjectsList.length;
                mouseObjectsList[mouseLength] = currentSource;
                mouseObjectsList[mouseLength].method = currentMethod;
            }
        }
    }

    if(mouseObjectsList.length > 0)
        mouseoverTextActive = true;
    else
        mouseoverTextActive = false;

    drawSources();
};

function handleMouseButtonDown(event)
{
    if(mouseX < 0 || mouseX > {{image.dimX}} || mouseY < 0 || mouseY > {{image.dimY}})
        return true;

    if(event.which == 1)
    {
        lmbDown = true;
        mouseXStart = mouseX;
        mouseYStart = mouseY;
    }

    drawSources();
};

function handleMouseButtonUp(event)
{
    if(event.which == 1)
    {
        //NOTE: These lines are duplicated elsewhere, if they change the others must too.
        var deltaX = mouseX - mouseXStart;
        var deltaY = mouseY - mouseYStart;
        var xPos = mouseX - reticlePrecision*deltaX;
        var yPos = mouseY - reticlePrecision*deltaY;

        if(lmbDown && mode == 'stars')
            userCreatedResults[userCreatedResults.length] = {x: xPos, y: yPos, confidence: 1.0};
        else if(lmbDown && mode == 'hotpixels')
            userCreatedHotPixels[userCreatedHotPixels.length] = {x: xPos, y: yPos, confidence: 1.0};

        lmbDown = false;
        drawSources();
    }

    $('#uploadResultsNumDiv').html(userCreatedResults.length);
    $('#hotPixelsNumDiv').html(userCreatedHotPixels.length);

    if(!submitButtonEnabled && (userCreatedResults.length == 1 || userCreatedHotPixels.length == 1))
    {
        submitButtonEnabled = true;
        $('#uploadMarkedStarsButton').hide(1000);
        $('#uploadMarkedStarsButton').prop( "disabled", false );
        $('#uploadMarkedStarsButton').show(1000);
    }
};

function handleKeyDown(event)
{
    if(!lmbDown && (mouseX < 0 || mouseX > {{image.dimX}} || mouseY < 0 || mouseY > {{image.dimY}}))
        return true;

    //alert(keyCodeDict[event.which]);
    keyStatusDict[keyCodeDict[event.which]] = true;
    countKeysPressed();

    drawSources();
};

function handleKeyUp(event)
{
    keyStatusDict[keyCodeDict[event.which]] = false;
    countKeysPressed();

    drawSources();
};

function countKeysPressed()
{
    var count = 0;
    for(var key in keyStatusDict)
        if(keyStatusDict[key])
            count++;

    numKeysPressed = count;
    //alert(numKeysPressed);

    switch(numKeysPressed)
    {
        case 0:
            mode = 'stars';
            break;

        case 1:
            if(keyStatusDict['ctrl'])
                mode = 'hotpixels';
            break;

        case 2:
            if(keyStatusDict['ctrl'] && keyStatusDict['x'])
                mode = 'hotlines';
            else if(keyStatusDict['ctrl'] && keyStatusDict['c'])
                mode = 'hotcolumns';
            break;
    }
};

window.onload = function()
{
    canvas = document.getElementById("sourcesCanvas");
    context = canvas.getContext("2d");

    //TODO: There are probably bugs here where you click the mouse down on the canvas and then release it elsewhere in the window, etc.
    $(document).mousemove(handleMouseMove);
    $(document).mousedown(handleMouseButtonDown);
    $(document).mouseup(handleMouseButtonUp);
    $("#sourcesCanvas").mouseenter(function(){document.body.style.cursor = 'none';});
    $("#sourcesCanvas").mouseleave(function(){document.body.style.cursor = oldMouseCursor;});
    $(document).keydown(handleKeyDown);
    $(document).keyup(handleKeyUp);
    countKeysPressed();

    $('#uploadMarkedStarsButton').prop( "disabled", true );

    var xdr = new Bokeh.DataRange1d({ follow: 'start' });
    var ydr = new Bokeh.DataRange1d({ follow: 'start' });

    plot = new Bokeh.Plotting.figure({
        toolbar_location: 'above',
        toolbar_sticky: false,
        x_range: xdr,
        y_range: ydr,
        plot_width: 600,
        plot_height: 600,
        background_fill_color: "#F2F2F7"
        });

    //TODO: One way to clear this plot would be to delete the innerHtml of this div and re-display the plot from scratch.
    div = document.getElementById("bokehPlotDiv");
    Bokeh.Plotting.show(plot, div);

    //TODO: Use the thumbnail url query rather than this hardcoded value, maybe?
    img = new Image();
    img.src = '{{image.getThumbnailUrlFull|safe}}';

    updateTable();

    getObjectsInImage();
    getUserSubmittedResults();
    getUserSubmittedHotPixels();
    getSextractorResults();
    getImage2xyResults();
    getDaofindResults();
    getStarfindResults();
    $.when(sextractorResultsPromise, image2xyResultsPromise, daofindResultsPromise, starfindResultsPromise).done(getSourceFindMatches);

};
</script>

{% endblock %}

