{% extends "cosmicapp/base.html" %}
{% load static %}

{% block extratitle %} - Image {{id}} sources viewer {% endblock %}

{% block extrahead %}

    <script src="/static/cosmicapp/math.min.js" type="text/javascript"></script>

    {% comment %}
    <link rel="stylesheet" href="http://cdn.pydata.org/bokeh/release/bokeh-0.12.9.min.css">
    <script src="http://cdn.pydata.org/bokeh/release/bokeh-0.12.9.min.js"></script>
    <script src="http://cdn.pydata.org/bokeh/release/bokeh-api-0.12.9.min.js"></script>
    {% endcomment %}
    <link rel="stylesheet" href="/static/cosmicapp/bokeh-0.12.9.min.css">
    <script src="/static/cosmicapp/bokeh-0.12.9.min.js"></script>
    <script src="/static/cosmicapp/bokeh-api-0.12.9.min.js"></script>

{% include "./jquery.html" %}

{% endblock extrahead %}

{% block mainbody %}

<p>
This page displays the bright sources (mostly stars) that were detected by the automatic
source detection algorithms in use on Cosmic.  There are currently four methods used:
</p>

<ul>
    <li> Source Extractor (Sextractor) </li>
    <li> Image2xy </li>
    <li> Daofind </li>
    <li> Starfind </li>
</ul>

<p>
Each method runs independantly, and then after all four have been run the results are
compared with each other (as well as with user submitted results) and the combined results
are recorded in the <i>multiple matches</i> category.  You can enable or disable the
display of each method by clicking the first checkbox under the name.  Other display
settings are set in a similar fashion.
</p>

<p>
If Some methods find <i>too many</i> or <i>too few</i> stars you can click on the
<i>feedback</i> button to tell Cosmic how many objects a given method should have found.
The number of objects found for that method and your feedback will be used to determine
which of the four methods should be re-run with different detection thresholds.  For
<a href="">images which do not plate solve</a> you can help us out by giving this kind of
feedback, and the plate solver will automatically be re-run after the source detection
algortithms have been re-run with your feedback.
</p>

<table border=2px style="border-collapse: collapse; margin: 1em;">
<tr>
<!-- TODO: Color this top row of cells the color of the given method color.  Since these
colors are defined in javascript, we need to do this in the window.onload function. -->
<th></th>
<th>Lock</th>
<th width=200 id=sextractorTableHeader>Sextractor<div id=sextractorLoadingDiv></div></th>
<th width=200 id=image2xyTableHeader>Image2xy<div id=image2xyLoadingDiv></div></th>
<th width=200 id=daofindTableHeader>Daofind<div id=daofindLoadingDiv></div></th>
<th width=200 id=starfindTableHeader>Starfind<div id=starfindLoadingDiv></div></th>
<th width=200 id=sourceFindMatchesTableHeader>Multiple Matches<div id=sourceFindMatchesLoadingDiv><br><br>Waiting...</div></th>
</tr>

<!-- TODO: Add a row at the top here showing how many results there are from each detection method -->

<tr>
<td>Enabled:</td>
<td align=center><input type=checkbox id=methodEnabledLockCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='sextractorResults'><input type=checkbox id=sextractorEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='image2xyResults'><input type=checkbox id=image2xyEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='daofindResults'><input type=checkbox id=daofindEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='starfindResults'><input type=checkbox id=starfindEnabledCheckbox onchange="updateTable(this.id)"></td>
<td align=center class='sourceFindMatchesResults'><input type=checkbox id=sourceFindMatchesEnabledCheckbox onchange="updateTable(this.id)" checked></td>
</tr>

<tr>
<td>Size:</td>
<td align=center><input type=checkbox id=methodSizeLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xySizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td>Size scale:</td>
<td align=center><input type=checkbox id=methodSizeScaleLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xySizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesSizeScaleSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td>Label thresh:</td>
<td align=center><input type=checkbox id=methodLabelThresholdLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xyLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td>Label size:</td>
<td align=center><input type=checkbox id=methodLabelSizeLockCheckbox onchange="updateTable(this.id)" checked></td>
<td class='sextractorResults'><input id="sextractorLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='image2xyResults'><input id="image2xyLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='daofindResults'><input id="daofindLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='starfindResults'><input id="starfindLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
<td class='sourceFindMatchesResults'><input id="sourceFindMatchesLabelSizeSlider" type=range min="0" max="100" value="50" onchange="updateTable(this.id)"></td>
</tr>

<tr>
<td colspan=2>Label:</td>
    <td class='sextractorResults'>
    <!-- TODO: Add x and y pixel values as options for labels. -->
    <input type=checkbox id=sextractorLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=sextractorLabelFluxErr onchange="drawSources()"> Flux Err<br>
    <input type=checkbox id=sextractorLabelFlags onchange="drawSources()"> Flags<br>
    <input type=checkbox id=sextractorLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='image2xyResults'>
    <input type=checkbox id=image2xyLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=image2xyLabelBackground onchange="drawSources()"> Background<br>
    <input type=checkbox id=image2xyLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='daofindResults'>
    <input type=checkbox id=daofindLabelMag onchange="drawSources()"> Magnitude<br>
    <input type=checkbox id=daofindLabelPeak onchange="drawSources()"> Peak<br>
    <input type=checkbox id=daofindLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=daofindLabelSharpness onchange="drawSources()"> Sharpness<br>
    <input type=checkbox id=daofindLabelSRound onchange="drawSources()"> Sym roundness<br>
    <input type=checkbox id=daofindLabelGRound onchange="drawSources()"> Gauss roundess<br>
    <input type=checkbox id=daofindLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='starfindResults'>
    <input type=checkbox id=starfindLabelMag onchange="drawSources()"> Magnitude<br>
    <input type=checkbox id=starfindLabelPeak onchange="drawSources()"> Peak<br>
    <input type=checkbox id=starfindLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=starfindLabelFWHM onchange="drawSources()"> FWHM<br>
    <input type=checkbox id=starfindLabelRoundness onchange="drawSources()"> Roundness<br>
    <input type=checkbox id=starfindLabelPA onchange="drawSources()"> PA<br>
    <input type=checkbox id=starfindLabelSharpness onchange="drawSources()"> Sharpness<br>
    <input type=checkbox id=starfindLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td class='sourceFindMatchesResults'>
    <input type=checkbox id=sourceFindMatchesLabelNum onchange="drawSources()" checked> Num Methods<br>
    <input type=checkbox id=sourceFindMatchesLabelConfidence onchange="drawSources()"> Confidence
    </td>
</tr>

<tr>
<td colspan=2>How did<br>we do:</td>
<td align=center class='sextractorResults'>
    <div id=sextractorFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('sextractor')"><br><br>
    </div>

    <div id=sextractorButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('sextractor', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('sextractor', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('sextractor', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('sextractor', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('sextractor', 'wayTooFew')">
    </div>
</td>

<td align=center class='image2xyResults'>
    <div id=image2xyFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('image2xy')"><br><br>
    </div>

    <div id=image2xyButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('image2xy', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('image2xy', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('image2xy', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('image2xy', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('image2xy', 'wayTooFew')">
    </div>
</td>

<td align=center class='daofindResults'>
    <div id=daofindFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('daofind')"><br><br>
    </div>

    <div id=daofindButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('daofind', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('daofind', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('daofind', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('daofind', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('daofind', 'wayTooFew')">
    </div>
</td>

<td align=center class='starfindResults'>
    <div id=starfindFeedbackButtonDiv>
    <input type=button class=button value="Feedback" onclick="feedbackButtonClicked('starfind')"><br><br>
    </div>

    <div id=starfindButtonDiv hidden>
    <input type=button class=button value="Found way too many" onclick="submitUserFeedback('starfind', 'wayTooMany')"><br><br>
    <input type=button class=button value="Found too many" onclick="submitUserFeedback('starfind', 'tooMany')"><br><br>
    <input type=button class=button value="About right" onclick="submitUserFeedback('starfind', 'aboutRight')"><br><br>
    <input type=button class=button value="Found too few" onclick="submitUserFeedback('starfind', 'tooFew')"><br><br>
    <input type=button class=button value="Found way too few" onclick="submitUserFeedback('starfind', 'wayTooFew')">
    </div>
</td>

</tr>
</table>

<div id=uploadResultsDiv>
    <p>
    Move your mouse over the image to examine the detected sources.  You can <i>shift+left
    click</i> on an object to display a page of information about all of the objects
    listed in the mouseover text.
    </p>

    <p>
    If there are dim stars that were not detected by the automatic search routines you can
    mark a few of them yourself.  Left click and hold the mouse button to carefully center
    on a star and then release the mouse button.  Keep in mind however that marking stars
    manually should only be used as a last resort after you have tried using the
    <i>feedback</i> buttons above several times and letting it run through the queue each
    time to re-run the platesolver.
    </p>

    <p>
    If you do decide to manually mark objects, the most useful thing to do is mark hot
    pixels (if there are any) with <i>ctrl+left click</i>.  If there are entire columns of
    hot pixels you can mark them by holding down <i>ctrl+c</i> while you click on the bad
    column, or <i>ctrl+x</i> to mark bad lines of bad pixels.  Marking stars that were
    missed by the automatic algorithms can be done by just <i>left-clicking</i> on them
    (but you should never have to mark more than a few this way, and only after using the
    <i>feedback</i> buttons above).
    </p>

    <div id=uploadResultsButtonDiv>
        <p>
        You have marked <span id=uploadResultsNumDiv>0</span> stars in the image below:
        <input id=uploadMarkedStarsButton type=button value="Upload marked objects." onclick="submitUserResults()">
        </p>

        <p>
        You have also marked
        <span id=hotPixelsNumDiv>0</span> hot pixels (<i>ctrl</i>),
        <span id=hotLinesNumDiv>0</span> bad lines (<i>ctrl + x</i>), and
        <span id=hotColumnsNumDiv>0</span> bad columns (<i>ctrl + c</i>).
        </p>

    </div>
</div>

<input type=button class=button value="-" onclick="adjustSliderValue('objectsLimitingMagSlider', -1)">
<input type=button class=button value="+" onclick="adjustSliderValue('objectsLimitingMagSlider', 1)">
<input id="objectsLimitingMagSlider" type=range min="-1" max="160" value="140" onchange="drawSources()" oninput="drawSources()">
<input type=checkbox id=objectsEnabledCheckbox checked>
<div id=objectsLimitingMagDiv style="display: inline-block"></div>
<br>

<div id="catalogTransformDiv" style="display: inline-block; float:right; border:2px solid lightgrey">
<table>
<tr>
<td colspan=2>Image to get plate solution from: <input type=text name=queryImageId value={{image.pk}}></td>
</tr>
<tr>
<td colspan=2>Plate Scale (arcsec/pixel): <input type=text name=plateScale value=1></td>
</tr>
<tr>
<td><input type=button value="Query" onclick="getObjectsInImage()"></td>
</tr>
<tr><td colspan=2 align=center> <a class=functionLink onclick="resetCatalogTransform()">Reset</a> </td></tr>
<tr>
    <td> Button increment: </td>
    <td align=center>
    <input style="width: 300px;" id="transformIncrementSlider" type=range min="1" max="10" value="5" onchange="updateTransformIncrement()">
    </td>
</tr>
<tr>
    <td> X Offset: </td>
    <td align=center>
    <input type=button value="-" onclick="adjustSliderValue('xOffsetSlider', -transformIncrement)">
    <input style="width: 300px;" id="xOffsetSlider" type=range min="-{{image.dimX}}" max="{{image.dimX}}" value="0" oninput="drawSources()">
    <input type=button value="+" onclick="adjustSliderValue('xOffsetSlider', transformIncrement)">
    </td>
</tr>

<tr>
    <td> X Scale: </td>
    <td align=center>
    <input type=button value="-" onclick="adjustSliderValue('xScaleSlider', -transformIncrement)">
    <input style="width: 300px;" id="xScaleSlider" type=range min="-1000" max="1000" value="200" oninput="drawSources()">
    <input type=button value="+" onclick="adjustSliderValue('xScaleSlider', transformIncrement)">
    </td>
</tr>

<tr>
    <td> Y Offset: </td>
    <td align=center>
    <input type=button value="-" onclick="adjustSliderValue('yOffsetSlider', -transformIncrement)">
    <input style="width: 300px;" id="yOffsetSlider" type=range min="-{{image.dimY}}" max="{{image.dimY}}" value="0" oninput="drawSources()">
    <input type=button value="+" onclick="adjustSliderValue('yOffsetSlider', transformIncrement)">
    </td>
</tr>

<tr>
    <td> Y Scale: </td>
    <td align=center>
    <input type=button value="-" onclick="adjustSliderValue('yScaleSlider', -transformIncrement)">
    <input style="width: 300px;" id="yScaleSlider" type=range min="-1000" max="1000" value="200" oninput="drawSources()">
    <input type=button value="+" onclick="adjustSliderValue('yScaleSlider', transformIncrement)">
    </td>
</tr>

<tr>
    <td> Rotation: </td>
    <td align=center>
    <input type=button value="-" onclick="adjustSliderValue('rotationSlider', -transformIncrement)">
    <input style="width: 300px;" id="rotationSlider" type=range min="-540" max="540" value="0" oninput="drawSources()">
    <input type=button value="+" onclick="adjustSliderValue('rotationSlider', transformIncrement)">
    </td>
</tr>
</table>

<input type=button value="Save Plate Solution" onclick="savePlateSolution()">

</div>

<canvas id="sourcesCanvas" width="{{image.dimX}}" height="{{image.dimY}}" style="border:4px solid #00A030">
Your browser does not support the HTML5 canvas tag.
</canvas>

<div id=bokehPlotDiv>
</div>

<script>
var imageId = {{id}};
var limitPerSource = 25000;  //TODO: Add a notice in each of the loading methods if the number returned equals this limit.
var objectsInImage = [], raDecMappingObjects = [];
var transformIncrement;
var minRA, maxRA, minDec, maxDec;
var sextractorResults = [], image2xyResults = [], daofindResults = [], starfindResults = [];
var userCreatedResults = [], userSubmittedResults = [];
var userCreatedHotPixels = [], userSubmittedHotPixels = [];
var sextractorResultsPromise, image2xyResultsPromise, daofindResultsPromise, starfindResultsPromise, userSubmittedResultsPromise;
var sourceFindMatches = [];
var finishedLoading = false;
var submitButtonEnabled = false;
var canvas, context;
var img;
var objectsColor = "#9df909";
var sextractorColor = "#E02010";
var image2xyColor = "#14D3FF";
var daofindColor = "#30A010";
var starfindColor = "#7199E2";
var sourceFindMatchesColor = "#F99740";
var userCreatedColor = "#fff766";
var numberOfBins = 10;
var mouseX = 0;
var mouseY = 0;
var mouseObjectsList = [];
var mouseXStart = -1;
var mouseYStart = -1;
var lmbDown = false;
var reticlePrecision = 0.66;
var mouseoverTextActive = false;
var oldMouseCursor = document.body.style.cursor;
var maxDistanceFromStar = 10;
var mouseTextHideDistance = 120;
var maxDistanceFromStarSquared = maxDistanceFromStar*maxDistanceFromStar;
var lastDrawSourcesTime = 0;
var feedbackSubmittedDict = {'sextractor': false, 'image2xy': false, 'daofind': false, 'starfind': false}

var plot;

var keyCodeDict = {
    17: 'ctrl',
    16: 'shift',
    67: 'c',
    88: 'x',
    90: 'z'
    }

var keyStatusDict = {
    'ctrl': false,
    'shift': false,
    'c': false,
    'x': false,
    'z': false
    }

var numKeysPressed = 0;
var mode = '';

function adjustSliderValue(sliderSelector, increment)
{
    var slider = document.getElementById(sliderSelector);
    slider.value = Number(slider.value) + Number(increment);
    drawSources();
};

function updateTransformIncrement()
{
    transformIncrement = document.getElementById('transformIncrementSlider').value;
};

function resetCatalogTransform()
{
    $('#xOffsetSlider').val(0);
    $('#yOffsetSlider').val(0);
    $('#rotationSlider').val(0);
    $('#xScaleSlider').val(100);
    $('#yScaleSlider').val(100);
    drawSources();
};

function transformRADec(ra, dec)
{
    rot = (math.pi/180)*crota1
    xCoord = ((ra - crval1)*math.cos((math.pi/180.0)*dec)) / cdelt1
    yCoord = (dec - crval2) / cdelt2
    xRot = xCoord*math.cos(rot) + yCoord*math.sin(rot)
    yRot = -xCoord*math.sin(rot) + yCoord*math.cos(rot)
    xCoord = xRot + crpix1;
    yCoord = yRot + crpix2;
    return [xCoord, yCoord];
};

function savePlateSolution()
{
    $.ajax({
        url : "/save/userComputedWCS/",
        type : "post",
        data: {
            imageId: imageId,
            crpix1: crpix1,
            crpix2: crpix2,
            crval1: crval1,
            crval2: crval2,
            cdelt1: cdelt1,
            cdelt2: cdelt2,
            crota1: crota1,
            crota2: crota2
            },
        dataType: 'json',
        success : function(response)
        {
            alert(response.text);
        },
        error : function(response)
        {
            response = response.responseJSON;
            alert(response.text);
        },
    });
};

function drawStroked(c, text, x, y, ignoreDistance=false)
{
    if(!ignoreDistance)
    {
        var deltaX = x - mouseX;
        var deltaY = {{image.dimY}} - y - mouseY;

        if(deltaX*deltaX + deltaY*deltaY < mouseTextHideDistance*mouseTextHideDistance)
            return;
    }

    oldLineWidth = c.lineWidth;
    oldStrokeStyle = c.strokeStyle;
    oldLineJoin = c.lineJoin;
    oldMiterLimit = c.miterLimit;

    c.lineWidth = 4;
    c.strokeStyle = 'black';
    c.lineJoin="miter"; //Experiment with "bevel" & "round" for the effect you want!
    c.miterLimit=2;

    c.strokeText(text, x, y);
    c.fillText(text, x, y);

    c.lineWidth = oldLineWidth;
    c.strokeStyle = oldStrokeStyle;
    c.lineJoin = oldLineJoin;
    c.miterLimit = oldMiterLimit;
};

function getObjectById(objectList, id)
{
    if(id == null)
        return null;

    for(index = 0; index < objectList.length; index++)
    {
        if(objectList[index].id == id)
            return objectList[index];
    }

    return null;
};

function binData(data, nBins)
{
    var i;

    if(data.length == 0)
        return null;

    // Caluculate the range of the input data.
    min = data[0], max = data[0];
    for(i = 0; i < data.length; i++)
    {
        if(data[i] < min)
            min = data[i];

        if(data[i] > max)
            max = data[i];
    }

    // Create the empty bins
    binSize = (max - min)/nBins;
    bins = [[], []];
    for(i = 0; i < nBins; i++)
    {
        bins[0][i] = min + i*binSize;
        bins[1][i] = 0;
    }

    // Loop over the data and sort it into bins.
    for(i = 0; i < data.length; i++)
    {
        binNumber = math.floor((data[i] - min)/binSize);
        binNumber = math.min(binNumber, nBins-1);
        bins[1][binNumber]++;
    }

    return bins;
};

//TODO: Split calls to this out on their own, or do them after the promise for loading each method is complete to speed up page loading.
function addHistogramToPlot(data, nBins, lineColor, legendStr, dashArray)
{
    bins = binData(data, nBins);
    if(bins == null)
        return

    dataSource = new Bokeh.ColumnDataSource({
        data: {
        x: bins[0],
        y: bins[1]
        } });

    l = bins[0].slice(0, bins[0].length);
    r = bins[0].slice(1, bins[0].length);
    r.push(2*bins[0][bins[0].length] - bins[0][bins[0].length]);
    t = bins[1];
    b = 0;

    quad = plot.quad(l, r, b, t, {
        line_color: '#000000',
        fill_color: lineColor,
        fill_alpha: 0.25,
        line_width: 2,
        line_dash: dashArray,
        legend: legendStr
        });

    // Hack to force a window resize event which makes the plot properly draw the axis labels.
    window.dispatchEvent(new Event('resize'));

    //plot.legend[0].location = "top_left";
    //plot.legend[0].click_policy="hide";

    return quad;
};

function getObjectsInImage()
{
    var i, j;
    var plateScale = document.getElementsByName('plateScale')[0].value;
    var queryImageId = document.getElementsByName('queryImageId')[0].value;
    document.getElementById('xScaleSlider').value = (200/plateScale);
    document.getElementById('yScaleSlider').value = (200/plateScale);
    bufferDistance = 4.0 * ({{image.dimX}}+{{image.dimY}})/4.0 * plateScale / 3600.0;

    objectsInImage = [];
    raDecMappingObjects = [];

    $.ajax({
        url : "/query/?queryfor=objectsInImage&bufferDistance=" + bufferDistance + "&limit=" + limitPerSource + "&imageId=" + queryImageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            //TODO: Need to add back in 'Asteroid'
            typeArray = [ '2MassXSC', 'Messier', 'GCVS', 'Exoplanet', 'UCAC4' ];

            for(image in response)
            {
                //TODO: Check image id number matches this image?

                for(j = 0; j < typeArray.length; j++)
                {
                    var catalog = typeArray[j];

                    results = response[image][catalog];
                    for(i = 0; i < results.length; i++)
                    {
                        switch(catalog)
                        {
                            case '2MassXSC':       mag = results[i].isophotalKMag;    break;
                            case 'Messier':        mag = results[i].magV;             break;
                            case 'GCVS':           mag = results[i].magMax;           break;
                            case 'Asteroid':       mag = results[i].mag;              break;
                            case 'Exoplanet':      mag = results[i].magV;             break;
                            case 'UCAC4':          mag = results[i].magAperture;      break;
                        }

                        results[i].catalog = catalog;
                        results[i].mag = mag;
                        if(isNaN(results[i].mag))
                            results[i].mag = -0.01;
                    }
                    objectsInImage = objectsInImage.concat(results);
                }
            }

            minRA = objectsInImage[0].ra;
            maxRA = objectsInImage[0].ra;
            minDec = objectsInImage[0].dec;
            maxDec = objectsInImage[0].dec;
            for(i = 0; i < objectsInImage.length; i++)
            {
                if(objectsInImage[i].ra < minRA)
                    minRA = objectsInImage[i].ra

                if(objectsInImage[i].ra > maxRA)
                    maxRA = objectsInImage[i].ra

                if(objectsInImage[i].dec < minDec)
                    minDec = objectsInImage[i].dec

                if(objectsInImage[i].dec > maxDec)
                    maxDec = objectsInImage[i].dec
            }

            drawSources();
        }
    });

    drawSources();
};

function getSextractorResults()
{
    var i;
    $('#sextractorLoadingDiv').html('<br><br>Loading...');

    sextractorResultsPromise = $.ajax({
        url : "/query/?queryfor=sextractorResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            fluxAutoValues = [];
            magAutoValues = [];

            sextractorResults = response;
            for(i = 0; i < sextractorResults.length; i++)
            {
                //TODO:  Add confidence for this and other types to the bokeh histogram plot.
                fluxAutoValues[i] = sextractorResults[i].fluxAuto;
                magAutoValues[i] = -2.5*math.log10(sextractorResults[i].fluxAuto);
            }

            Promise.resolve(true);

            //addHistogramToPlot(fluxAutoValues, numberOfBins, sextractorColor, 'Flux (sextractor)', []);
            addHistogramToPlot(magAutoValues, numberOfBins, sextractorColor, 'Mag (sextractor)', []);

            drawSources();
            $('#sextractorLoadingDiv').html("<br>" + sextractorResults.length + " Results<br>Loaded");
            $('#sextractorTableHeader').attr('bgcolor', sextractorColor);
        }
    });
};

function getUserSubmittedResults()
{
    var i;

    userSubmittedResultsPromise = $.ajax({
        url : "/query/?queryfor=userSubmittedResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            var i;
            userSubmittedResults = response;
            raDecMappingObjects = [];
            for(i = 0; i < userSubmittedResults.length; i++)
                if(userSubmittedResults[i].ra != null && userSubmittedResults[i].dec != null)
                    raDecMappingObjects[raDecMappingObjects.length] = userSubmittedResults[i];

            Promise.resolve(true);
            drawSources();
        }
    });
};

function getUserSubmittedHotPixels()
{
    var i;

    $.ajax({
        url : "/query/?queryfor=userSubmittedHotPixel&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            userSubmittedHotPixels = response;
            drawSources();
        }
    });
};

function getImage2xyResults()
{
    var i;

    $('#image2xyLoadingDiv').html('<br><br>Loading...');

    image2xyResultsPromise = $.ajax({
        url : "/query/?queryfor=image2xyResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            fluxValues = [];
            magValues = [];

            image2xyResults = response;
            for(i = 0; i < image2xyResults.length; i++)
            {
                //TODO:  Add confidence for this and other types to the bokeh histogram plot.
                fluxValues[i] = image2xyResults[i].flux;
                magValues[i] = -2.5*math.log10(image2xyResults[i].flux);
            }

            Promise.resolve(true);

            //addHistogramToPlot(fluxValues, numberOfBins, image2xyColor, 'Flux (image2xy)', []);
            addHistogramToPlot(magValues, numberOfBins, image2xyColor, 'Mag (image2xy)', []);

            drawSources();
            $('#image2xyLoadingDiv').html("<br>" + image2xyResults.length + " Results<br>Loaded");
            $('#image2xyTableHeader').attr('bgcolor', image2xyColor);
        }
    });
};

function getDaofindResults()
{
    var i;

    $('#daofindLoadingDiv').html('<br><br>Loading...');

    daofindResultsPromise = $.ajax({
        url : "/query/?queryfor=daofindResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            magValues = [];
            //fluxValues = [];
            //peakValues = [];
            //sharpnessValues = [];
            //sroundValues = [];
            //groundValues = [];

            daofindResults = response;
            for(i = 0; i < daofindResults.length; i++)
            {
                magValues[i] = daofindResults[i].mag;
                //fluxValues[i] = daofindResults[i].flux;
                //peakValues[i] = daofindResults[i].peak;
                //sharpnessValues[i] = daofindResults[i].sharpness;
                //sroundValues[i] = daofindResults[i].sround;
                //groundValues[i] = daofindResults[i].ground;
            }

            Promise.resolve(true);

            addHistogramToPlot(magValues, numberOfBins, daofindColor, 'Mag (daofind)', []);
            //addHistogramToPlot(fluxValues, numberOfBins, daofindColor, 'Flux (daofind)', [1, 3]);
            //addHistogramToPlot(peakValues, numberOfBins, daofindColor, 'Peak(daofind)', [1, 3, 3, 5]);
            //addHistogramToPlot(sharpnessValues, numberOfBins, daofindColor, 'Sharpness (daofind)', [3, 3]);
            //addHistogramToPlot(sroundValues, numberOfBins, daofindColor, 'S Round (daofind)', [3, 6]);
            //addHistogramToPlot(groundValues, numberOfBins, daofindColor, 'G Round (daofind)', [6, 6]);

            drawSources();
            $('#daofindLoadingDiv').html("<br>" + daofindResults.length + " Results<br>Loaded");
            $('#daofindTableHeader').attr('bgcolor', daofindColor);
        }
    });
};

function getStarfindResults()
{
    var i;

    $('#starfindLoadingDiv').html('<br><br>Loading...');

    starfindResultsPromise = $.ajax({
        url : "/query/?queryfor=starfindResult&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            magValues = [];
            //peakValues = [];
            //fluxValues = [];
            //fwhmValues = [];
            //roundnessValues = [];
            //paValues = [];
            //sharpnessValues = [];

            starfindResults = response;
            for(i = 0; i < starfindResults.length; i++)
            {
                magValues[i] = starfindResults[i].mag;
                //peakValues[i] = starfindResults[i].peak;
                //fluxValues[i] = starfindResults[i].flux;
                //fwhmValues[i] = starfindResults[i].fwhm;
                //roundnessValues[i] = starfindResults[i].roundness;
                //paValues[i] = starfindResults[i].pa;
                //sharpnessValues[i] = starfindResults[i].sharpness;
            }

            Promise.resolve(true);

            addHistogramToPlot(magValues, numberOfBins, starfindColor, 'Mag (starfind)', []);
            //addHistogramToPlot(peakValues, numberOfBins, starfindColor, 'Peak (starfind)', [1, 3]);
            //addHistogramToPlot(fluxValues, numberOfBins, starfindColor, 'Flux (starfind)', [1, 3, 3, 5]);
            //addHistogramToPlot(fwhmValues, numberOfBins, starfindColor, 'FWHM (starfind)', [3, 6]);
            //addHistogramToPlot(roundnessValues, numberOfBins, starfindColor, 'Roundness (starfind)', [6, 6]);
            //addHistogramToPlot(paValues, numberOfBins, starfindColor, 'PA (starfind)', [2, 2, 5]);
            //addHistogramToPlot(sharpnessValues, numberOfBins, starfindColor, 'Sharpness (starfind)', [2, 2, 2, 2, 5]);

            drawSources();
            $('#starfindLoadingDiv').html("<br>" + starfindResults.length + " Results<br>Loaded");
            $('#starfindTableHeader').attr('bgcolor', starfindColor);
        }
    });
};

function getSourceFindMatches()
{
    var i;

    $('#sourceFindMatchesLoadingDiv').html('<br><br>Loading...');

    $.ajax({
        url : "/query/?queryfor=sourceFindMatch&limit=" + limitPerSource + "&imageId=" + imageId,
        type : "get",
        async: true,
        dataType: 'json',
        success : function(response)
        {
            $.when(sextractorResultsPromise, image2xyResultsPromise, daofindResultsPromise,
                starfindResultsPromise,userSubmittedResultsPromise).done(function() {

                sourceFindMatches = response;
                for(i = 0; i < sourceFindMatches.length; i++)
                {
                    sextractorId = sourceFindMatches[i].sextractorResult;
                    image2xyId = sourceFindMatches[i].image2xyResult;
                    daofindId = sourceFindMatches[i].daofindResult;
                    starfindId = sourceFindMatches[i].starfindResult;
                    userSubmittedId = sourceFindMatches[i].userSubmittedResult;

                    sourceFindMatches[i].sextractorResult = getObjectById(sextractorResults, sourceFindMatches[i].sextractorResultId);
                    sourceFindMatches[i].image2xyResult = getObjectById(image2xyResults, sourceFindMatches[i].image2xyResultId);
                    sourceFindMatches[i].daofindResult = getObjectById(daofindResults, sourceFindMatches[i].daofindResultId);
                    sourceFindMatches[i].starfindResult = getObjectById(starfindResults, sourceFindMatches[i].starfindResultId);
                    sourceFindMatches[i].userSubmittedResult = getObjectById(userSubmittedResults, sourceFindMatches[i].userSubmittedResultId);
                }

                finishedLoading = true;
                drawSources();
                $('#sourceFindMatchesLoadingDiv').html("<br>" + sourceFindMatches.length + " Results<br>Loaded");
                $('#sourceFindMatchesTableHeader').attr('bgcolor', sourceFindMatchesColor);
            });
        }
    });
};

function submitUserResults()
{
    var i;
    var commaString;

    $.ajax({
        url : "/save/userSubmittedSourceResults/",
        type : "post",
        data: {userResults: JSON.stringify(userCreatedResults), hotPixels: JSON.stringify(userCreatedHotPixels), imageId: imageId},
        dataType: 'json',
        success : function(response)
        {
            alert(response.text);

            userCreatedResults = [];
            userSubmittedResults = [];
            getUserSubmittedResults();

            userCreatedHotPixels = [];
            userSubmittedHotPixels = [];
            getUserSubmittedHotPixels();
        }
        //TODO: Implement error handler.
    });
};

function feedbackButtonClicked(method)
{
    $('#methodEnabledLockCheckbox').prop('checked', false)
    $('#sextractorEnabledCheckbox').prop('checked', false)
    $('#image2xyEnabledCheckbox').prop('checked', false)
    $('#daofindEnabledCheckbox').prop('checked', false)
    $('#starfindEnabledCheckbox').prop('checked', false)
    $('#sourceFindMatchesEnabledCheckbox').prop('checked', false)

    $('#' + method + 'EnabledCheckbox').prop('checked', true)

    updateTable('feedbackButton');

    $('#' + method + 'FeedbackButtonDiv').hide();
    $('#' + method + 'ButtonDiv').show();

    $('#sourcesCanvas')[0].scrollIntoView({behaviour: 'smooth', block: 'start', inline: 'start'});
};

function submitUserFeedback(method, feedback)
{
    $('#' + method + 'ButtonDiv').fadeOut(0);
    if(feedback == 'aboutRight')
        $('#' + method + 'ButtonDiv').html("Thank you.  We will use this to guide the refinement of the other source detection algorithms for this image.");
    else
        $('#' + method + 'ButtonDiv').html("Thank you.  New results will be available in a minute or two.");
    $('#' + method + 'ButtonDiv').fadeIn(2000);

    $.ajax({
        url : "/save/userSubmittedFeedback/",
        type : "post",
        data: {method: method, feedback, feedback, imageId: imageId},
        dataType: 'json',
        success : function(response)
        {
            alert(response.text);

            feedbackSubmittedDict[method] = true;
            for(otherMethod in feedbackSubmittedDict)
            {
                if(otherMethod == method)
                    continue;

                switch(method)
                {
                    case 'sextractor':   theseResults = sextractorResults;   break;
                    case 'image2xy':     theseResults = image2xyResults;     break;
                    case 'daofind':      theseResults = daofindResults;      break;
                    case 'starfind':     theseResults = starfindResults;     break;
                }

                switch(otherMethod)
                {
                    case 'sextractor':   results = sextractorResults;   break;
                    case 'image2xy':     results = image2xyResults;     break;
                    case 'daofind':      results = daofindResults;      break;
                    case 'starfind':     results = starfindResults;     break;
                }

                if(feedback == 'tooMany')
                    if(results.length > theseResults.length)
                    {
                        feedbackSubmittedDict[otherMethod] = true;
                        $('#' + otherMethod + 'FeedbackButtonDiv').hide();
                        $('#' + otherMethod + 'ButtonDiv').fadeOut(0);
                        $('#' + otherMethod + 'ButtonDiv').html("There are even more results on this method.");
                        $('#' + otherMethod + 'ButtonDiv').fadeIn(5000);
                    }

                if(feedback == 'tooFew')
                    if(results.length < theseResults.length)
                    {
                        feedbackSubmittedDict[otherMethod] = true;
                        $('#' + otherMethod + 'FeedbackButtonDiv').hide();
                        $('#' + otherMethod + 'ButtonDiv').fadeOut(0);
                        $('#' + otherMethod + 'ButtonDiv').html("There are even fewer results on this method.");
                        $('#' + otherMethod + 'ButtonDiv').fadeIn(5000);
                    }

                if(feedback == 'aboutRight')
                {
                    feedbackSubmittedDict[otherMethod] = true;
                    $('#' + otherMethod + 'FeedbackButtonDiv').hide();
                    $('#' + otherMethod + 'ButtonDiv').fadeOut(0);
                    $('#' + otherMethod + 'ButtonDiv').html("Done.");
                    $('#' + otherMethod + 'ButtonDiv').fadeIn(5000);
                }
            }
        }
        //TODO: Implement error handler.
    });

};

function constructLabelText(paramArray)
{
    var i;
    var labelArray = [];
    var id, value, round;
    for(i = 0; i < paramArray.length; i++)
    {
        id = paramArray[i][0];
        value = paramArray[i][1];
        round = paramArray[i][2];

        if($(id).is(':checked'))
            labelArray[i] = math.round(value, round);
    }

    return labelArray.join(' ');
};

function drawSource(c, x, y, size, sizeFactor, sizeScaleFactor, boxXMin=undefined, boxYMin=undefined, boxXMax=undefined, boxYMax=undefined)
{
    var oldGlobalAlpha = c.globalAlpha;

    var deltaX = x - mouseX;
    var deltaY = y - mouseY;

    var dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
    var multiplier = 15;
    if(dist < maxDistanceFromStar)
        return;

    if(dist < multiplier*maxDistanceFromStar)
        context.globalAlpha = Math.max(0.2, Math.pow(dist/(multiplier*maxDistanceFromStar), 3));

    var drawRadius = sizeFactor*Math.pow(size, sizeScaleFactor);
    drawRadius = math.min(drawRadius, 20);
    drawRadius = math.max(drawRadius, 2);

    c.beginPath();
    c.arc(x, {{image.dimY}} - y, drawRadius, 0, 2*Math.PI)
    c.stroke();

    if(!(boxYMax === undefined))
    {
        if(math.abs(boxXMax-boxXMin) > 8 && math.abs(boxYMax-boxYMin) > 8)
        {
            c.beginPath();
            c.rect(boxXMin, {{image.dimY}} - boxYMin, boxXMax-boxXMin, boxYMin-boxYMax);
            c.stroke();
        }
    }

    context.globalAlpha = oldGlobalAlpha;
};

function drawHLine(c, y, color='#A02020', opacity=-1)
{
    var oldGlobalAlpha = c.globalAlpha;
    var oldStrokeStyle = c.strokeStyle;
    var oldFillStyle = c.fillStyle;
    c.strokeStyle = color;
    c.fillStyle = color;

    if(opacity == -1)
        c.globalAlpha = 0.2;
    else
        c.globalAlpha = opacity;

    c.beginPath();
    c.moveTo(0, {{image.dimY}} - y);
    c.lineTo({{image.dimX}}, {{image.dimY}} - y);
    c.stroke();

    c.strokeStyle = oldStrokeStyle;
    c.fillStyle = oldFillStyle;
    context.globalAlpha = oldGlobalAlpha;
};

function drawVLine(c, x, color='#A02020', opacity=-1)
{
    var oldGlobalAlpha = c.globalAlpha;
    var oldStrokeStyle = c.strokeStyle;
    var oldFillStyle = c.fillStyle;
    c.strokeStyle = color;
    c.fillStyle = color;

    if(opacity == -1)
        c.globalAlpha = 0.2;
    else
        c.globalAlpha = opacity;

    c.beginPath();
    c.moveTo(x, 0);
    c.lineTo(x, {{image.dimY}});
    c.stroke();

    c.strokeStyle = oldStrokeStyle;
    c.fillStyle = oldFillStyle;
    context.globalAlpha = oldGlobalAlpha;
};

function drawReticle(c, x, y, size, color='#A02020', opacity=-1, forceDraw=false)
{
    var oldGlobalAlpha = c.globalAlpha;
    var multiplier = 15;

    if(!forceDraw)
    {
        var deltaX = x - mouseX;
        var deltaY = y - mouseY;

        var dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
        if(dist < maxDistanceFromStar)
            return;
    }

    if(dist < multiplier*maxDistanceFromStar)
        var opacity1 = Math.max(0.2, Math.pow(dist/(multiplier*maxDistanceFromStar), 3));

    var xPos = x;
    var yPos = {{image.dimY}} - y;

    if(opacity == -1)
        opacity2 = 0.4 + 0.6*Math.pow(mouseObjectsList.length/3, 2);
    else
        opacity2 = opacity;

    c.globalAlpha = math.min(opacity1, opacity2);

    oldStrokeStyle = c.strokeStyle;
    oldFillStyle = c.fillStyle;
    c.strokeStyle = color;
    c.fillStyle = color;

    var i;
    var angle = Math.PI/8;

    c.beginPath();
    c.arc(xPos, yPos, size, 0, 2*Math.PI)
    c.stroke();

    c.beginPath();
    c.moveTo(xPos-size*.2, yPos);
    c.lineTo(xPos-size*.66, yPos);
    c.stroke();

    c.beginPath();
    c.moveTo(xPos+size*.2, yPos);
    c.lineTo(xPos+size*.66, yPos);
    c.stroke();

    c.beginPath();
    c.moveTo(xPos, yPos-size*.2);
    c.lineTo(xPos, yPos-size*.66);
    c.stroke();

    c.beginPath();
    c.moveTo(xPos, yPos+size*.2);
    c.lineTo(xPos, yPos+size*.66);
    c.stroke();

    for(i = 0; i < 4; i++)
    {
        c.beginPath();
        c.arc(xPos, yPos, size*.66, i*Math.PI/2-angle, i*Math.PI/2+angle)
        c.stroke();
    }

    c.strokeStyle = oldStrokeStyle;
    c.fillStyle = oldFillStyle;
    context.globalAlpha = oldGlobalAlpha;
};

function drawSources(forceDraw=true)
{
    var i;

    var d = new Date();
    var currentMilliseconds = d.getTime();
    if(!forceDraw && currentMilliseconds - lastDrawSourcesTime < 100)
    {
        //TODO: Need to start a timer or something to trigger a redraw after the timeout has expired.
        return;
    }

    lastDrawSourcesTime = currentMilliseconds;

    context.drawImage(img, 0, 0);
    context.lineWidth = 2;

    context.strokeStyle = objectsColor;
    context.fillStyle = objectsColor;
    limitingMag = $('#objectsLimitingMagSlider').val()/10;
    var xOffset = Number($('#xOffsetSlider').val());
    var yOffset = Number($('#yOffsetSlider').val());
    var rotation = $('#rotationSlider').val()/3.0*(math.pi/180.0);
    var xScale = 200.0/$('#xScaleSlider').val();
    var yScale = 200.0/$('#yScaleSlider').val();
    raRange = maxRA - minRA;
    decRange = maxDec - minDec;

    if(raDecMappingObjects.length > 0)
    {
        crpix1 = raDecMappingObjects[0].pixelX;
        crpix2 = raDecMappingObjects[0].pixelY;
        crval1 = raDecMappingObjects[0].ra;
        crval2 = raDecMappingObjects[0].dec;
        //alert(crpix1 + ' ' + crpix2 + ' ' + crval1 + ' ' + crval2)

    }
    else
    {
        crpix1 = 0.5*({{image.dimX}}+1) + xOffset;
        crpix2 = 0.5*({{image.dimY}}+1) + yOffset;
        crval1 = minRA + 0.5*raRange;
        crval2 = minDec + 0.5*decRange;
    }

    // TODO: Re-enable the extra constraints if you have 2 or more known sources.  For now, a single constraint
    // makes manual solving so easy that making the second constraint work is less critical.
    //if(raDecMappingObjects.length > 1)
    if(false)
    {
        dx = raDecMappingObjects[1].pixelX - raDecMappingObjects[0].pixelX;
        dy = raDecMappingObjects[1].pixelY - raDecMappingObjects[0].pixelY;
        dRA = raDecMappingObjects[1].ra - raDecMappingObjects[0].ra;
        dDec = raDecMappingObjects[1].dec - raDecMappingObjects[0].dec;
        cdelt1 = dRA/dx;
        cdelt2 = dDec/dy;
    }
    else
    {
        cdelt1 = xScale/3600.0;
        cdelt2 = yScale/3600.0;
    }
    crota1 = (180.0/math.pi)*rotation
    crota2 = (180.0/math.pi)*rotation
    drawStroked(context, 'Plate scale: ' + (cdelt1*3600).toFixed(2) + 'x' + (cdelt2*3600).toFixed(2) + 'arcsec/pixel', 10, 20);

    $('#objectsLimitingMagDiv').html("Catalog objects limiting Magnitude: " + limitingMag);
    if($('#objectsEnabledCheckbox').is(':checked'))
    for(i = 0; i < objectsInImage.length && !lmbDown; i++)
    {
        var mag = objectsInImage[i].mag;
        if(mag < 0.00001)
            mag = 1000;

        var xCoord, yCoord;
        if(mag < limitingMag || (limitingMag > 15 && mag > 999))
        {
            if(objectsInImage[i].pixelX != null || objectsInImage[i].pixelY != null)
            {
                xCoord = objectsInImage[i].pixelX
                yCoord = objectsInImage[i].pixelY
            }
            else
            {
                xyCoords = transformRADec(objectsInImage[i].ra, objectsInImage[i].dec)
                xCoord = xyCoords[0]
                yCoord = xyCoords[1]
            }

            if(objectsInImage[i].catalog == 'UCAC4')
                drawSource(context, xCoord, yCoord, 2.0, math.max(18-mag, 1), 1.0);
            else
                drawReticle(context, xCoord, yCoord, math.max(20-mag, 5), objectsColor, 1.0);
        }
    }

    context.strokeStyle = sextractorColor;
    context.fillStyle = sextractorColor;

    sizeFactor = $('#sextractorSizeSlider').val();
    sizeScaleFactor = 1 + $('#sextractorSizeScaleSlider').val()/25.0;
    labelThreshold = $('#sextractorLabelThresholdSlider').val()/100.0;
    labelSize= $('#sextractorLabelSizeSlider').val()/5 + 10
    if($('#sextractorEnabledCheckbox').is(':checked'))
    for(i = 0; i < sextractorResults.length && !lmbDown; i++)
    {
        drawSource(context, sextractorResults[i].pixelX, sextractorResults[i].pixelY, sextractorResults[i].confidence, sizeFactor, sizeScaleFactor,
                   sextractorResults[i].boxXMin, sextractorResults[i].boxYMin, sextractorResults[i].boxXMax, sextractorResults[i].boxYMax);

        if(sextractorResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#sextractorLabelFlux', sextractorResults[i].fluxAuto, 2],
                ['#sextractorLabelFluxErr', sextractorResults[i].fluxAutoErr, 2],
                ['#sextractorLabelFlags', sextractorResults[i].flags, 0],
                ['#sextractorLabelConfidence', sextractorResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, sextractorResults[i].pixelX + labelSize/2, {{image.dimY}} - sextractorResults[i].pixelY - labelSize)
        }
    }

    context.strokeStyle = image2xyColor;
    context.fillStyle = image2xyColor;

    sizeFactor = $('#image2xySizeSlider').val();
    sizeScaleFactor = 1.0 + $('#image2xySizeScaleSlider').val()/25.0;
    labelThreshold = $('#image2xyLabelThresholdSlider').val()/100.0;
    labelSize= $('#image2xyLabelSizeSlider').val()/5 + 10
    if($('#image2xyEnabledCheckbox').is(':checked'))
    for(i = 0; i < image2xyResults.length && !lmbDown; i++)
    {
        drawSource(context, image2xyResults[i].pixelX, image2xyResults[i].pixelY, image2xyResults[i].confidence, sizeFactor, sizeScaleFactor);

        if(image2xyResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#image2xyLabelFlux', image2xyResults[i].flux, 2],
                ['#image2xyLabelBackground', image2xyResults[i].background, 2],
                ['#image2xyLabelConfidence', image2xyResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, image2xyResults[i].pixelX + labelSize/2, {{image.dimY}} - image2xyResults[i].pixelY)
        }
    }

    context.strokeStyle = daofindColor;
    context.fillStyle = daofindColor;

    sizeFactor = $('#daofindSizeSlider').val();
    sizeScaleFactor = 1.0 + $('#daofindSizeScaleSlider').val()/25.0;
    labelThreshold = $('#daofindLabelThresholdSlider').val()/100.0;
    labelSize= $('#daofindLabelSizeSlider').val()/5 + 10
    if($('#daofindEnabledCheckbox').is(':checked'))
    for(i = 0; i < daofindResults.length && !lmbDown; i++)
    {
        drawSource(context, daofindResults[i].pixelX, daofindResults[i].pixelY, daofindResults[i].confidence, sizeFactor, sizeScaleFactor);

        if(daofindResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#daofindLabelMag', daofindResults[i].mag, 2],
                ['#daofindLabelPeak', daofindResults[i].peak, 2],
                ['#daofindLabelFlux', daofindResults[i].flux, 2],
                ['#daofindLabelSharpness', daofindResults[i].sharpness, 2],
                ['#daofindLabelSRound', daofindResults[i].sround, 2],
                ['#daofindLabelGRound', daofindResults[i].ground, 2],
                ['#daofindLabelConfidence', daofindResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, daofindResults[i].pixelX + labelSize/2, {{image.dimY}} - daofindResults[i].pixelY + labelSize)
        }
    }

    context.strokeStyle = starfindColor;
    context.fillStyle = starfindColor;

    sizeFactor = $('#starfindSizeSlider').val();
    sizeScaleFactor = 1.0 + $('#starfindSizeScaleSlider').val()/25.0;
    labelThreshold = $('#starfindLabelThresholdSlider').val()/100.0;
    labelSize= $('#starfindLabelSizeSlider').val()/5 + 10
    if($('#starfindEnabledCheckbox').is(':checked'))
    for(i = 0; i < starfindResults.length && !lmbDown; i++)
    {
        drawSource(context, starfindResults[i].pixelX, starfindResults[i].pixelY, starfindResults[i].confidence, sizeFactor, sizeScaleFactor);

        if(starfindResults[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#starfindLabelMag', starfindResults[i].mag, 2],
                ['#starfindLabelPeak', starfindResults[i].peak, 2],
                ['#starfindLabelFlux', starfindResults[i].flux, 2],
                ['#starfindLabelFWHM', starfindResults[i].fwhm, 2],
                ['#starfindLabelRoundness', starfindResults[i].roundness, 2],
                ['#starfindLabelPA', starfindResults[i].pa, 2],
                ['#starfindLabelSharpness', starfindResults[i].sharpness, 2],
                ['#starfindLabelConfidence', starfindResults[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            drawStroked(context, labelText, starfindResults[i].pixelX + labelSize/2, {{image.dimY}} - starfindResults[i].pixelY + 2*labelSize)
        }
    }

    context.strokeStyle = sourceFindMatchesColor;
    context.fillStyle = sourceFindMatchesColor;

    sizeFactor = $('#sourceFindMatchesSizeSlider').val();
    sizeScaleFactor = $('#sourceFindMatchesSizeScaleSlider').val()/25.0;
    labelThreshold = $('#sourceFindMatchesLabelThresholdSlider').val()/100.0;
    labelSize= $('#sourceFindMatchesLabelSizeSlider').val()/5 + 10
    if($('#sourceFindMatchesEnabledCheckbox').is(':checked'))
    for(i = 0; i < sourceFindMatches.length && !lmbDown; i++)
    {
        drawSource(context, sourceFindMatches[i].pixelX, sourceFindMatches[i].pixelY, sourceFindMatches[i].confidence, sizeFactor, sizeScaleFactor);

        if(sourceFindMatches[i].confidence > labelThreshold)
        {
            labelText = constructLabelText([
                ['#sourceFindMatchesLabelNum', sourceFindMatches[i].numMatches, 0],
                ['#sourceFindMatchesLabelConfidence', sourceFindMatches[i].confidence, 2],
                ]);

            context.font = labelSize + 'px sans-serif'
            context.textAlign = 'end';
            drawStroked(context, labelText, sourceFindMatches[i].pixelX - labelSize/2, {{image.dimY}} - sourceFindMatches[i].pixelY)
            context.textAlign = 'start';
        }
    }

    context.strokeStyle = userCreatedColor;
    context.fillStyle = userCreatedColor;

    for(i = 0; i < userSubmittedResults.length && !lmbDown; i++)
        drawSource(context, userSubmittedResults[i].pixelX, userSubmittedResults[i].pixelY, 1.0, 10, 2);

    for(i = 0; i < userSubmittedHotPixels.length && !lmbDown; i++)
        drawSource(context, userSubmittedHotPixels[i].pixelX, userSubmittedHotPixels[i].pixelY, 1.0, 5, 2);

    for(i = 0; i < userCreatedResults.length && !lmbDown; i++)
        drawReticle(context, userCreatedResults[i].pixelX, userCreatedResults[i].pixelY, 10, userCreatedColor, 0.8);

    for(i = 0; i < userCreatedHotPixels.length && !lmbDown; i++)
        drawReticle(context, userCreatedHotPixels[i].pixelX, userCreatedHotPixels[i].pixelY, 5, userCreatedColor, 0.8);

    labelSize = 16
    context.font = labelSize + 'px sans-serif'
    if(mouseX > {{image.dimX}} * (2/3))
    {
        context.textAlign = 'end';
        xPos = mouseX - 50;
        yPosInit = mouseY;
    }
    else if(mouseX < {{image.dimX}} * (1/3))
    {
        context.textAlign = 'start';
        xPos = mouseX + 50;
        yPosInit = mouseY;
    }
    else
    {
        context.textAlign = 'start';
        xPos = mouseX - 80;
        if(mouseY < {{image.dimY}} * (1/2))
            yPosInit = mouseY + 70;
        else
            yPosInit = mouseY - 70;
    }

    yPos = yPosInit - (mouseY/{{image.dimY}})*(mouseObjectsList.length-0)*(labelSize+4) + 30*(1.0-mouseY/{{image.dimY}});

    var raDecPrinted = false;
    for(i = 0; i < mouseObjectsList.length && !lmbDown; i++)
    {
        switch(mouseObjectsList[i].method)
        {
            case 'sextractor':
                context.strokeStyle = sextractorColor;
                context.fillStyle = sextractorColor;
                break;

            case 'image2xy':
                context.strokeStyle = image2xyColor;
                context.fillStyle = image2xyColor;
                break;

            case 'daofind':
                context.strokeStyle = daofindColor;
                context.fillStyle = daofindColor;
                break;

            case 'starfind':
                context.strokeStyle = starfindColor;
                context.fillStyle = starfindColor;
                break;

            case 'multi':
                context.strokeStyle = sourceFindMatchesColor;
                context.fillStyle = sourceFindMatchesColor;
                break;

            case 'user - not uploaded':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'user - hot pixel - not uploaded':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'user - hot pixel':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'userSubmittedResult':
                context.strokeStyle = userCreatedColor;
                context.fillStyle = userCreatedColor;
                break;

            case 'Catalog':
                context.strokeStyle = objectsColor;
                context.fillStyle = objectsColor;
                break;

            default:
                alert("Unhandled case statement for value: " + mouseObjectsList[i].method);
                break;
        }

        if(mouseObjectsList[i].method == 'Catalog')
            drawStroked(context, mouseObjectsList[i].catalog + "  " + mouseObjectsList[i].identifier
                        + "  " + math.round(mouseObjectsList[i].mag, 2), xPos, {{image.dimY}} - yPos - i*(labelSize+4), true);
        else
            drawStroked(context, mouseObjectsList[i].method + " " + math.round(mouseObjectsList[i].confidence, 2),
                        xPos, {{image.dimY}} - yPos - i*(labelSize+4), true);

        if(!raDecPrinted)
        {
            raDecPrinted = true;
            drawStroked(context, "ra dec: " + math.round(mouseObjectsList[i].ra, 3) + "   "
            + math.round(mouseObjectsList[i].dec, 3),
                        xPos, {{image.dimY}} - yPos + (labelSize+4), true);
        }
    }

    if(lmbDown)
    {
        //NOTE: These lines are duplicated elsewhere, if they change the others must too.
        var deltaX = mouseX - mouseXStart;
        var deltaY = mouseY - mouseYStart;
        var xPos = mouseX - reticlePrecision*deltaX;
        var yPos = mouseY - reticlePrecision*deltaY;

        if(mode == 'stars' || mode == 'hotpixels')
            drawReticle(context, xPos, yPos, 30, userCreatedColor, 0.8, true);
        else if(mode == 'hotlines')
            drawHLine(context, yPos, userCreatedColor, 0.8);
        else if(mode == 'hotcolumns')
            drawVLine(context, xPos, userCreatedColor, 0.8);
    }
    else
    {
        if(mode == 'stars' || mode == 'hotpixels')
        {
            if(mouseoverTextActive)
                drawReticle(context, mouseX, mouseY, 30/reticlePrecision, userCreatedColor, 0.8, true);
            else
                drawReticle(context, mouseX, mouseY, 30/reticlePrecision, userCreatedColor, 0.4, true);
        }
        else if(mode == 'hotlines')
            drawHLine(context, mouseY, userCreatedColor, 0.8);
        else if(mode == 'hotcolumns')
            drawVLine(context, mouseX, userCreatedColor, 0.8);
    }

    context.textAlign = 'start';

    if(!finishedLoading)
        drawStroked(context, "Loading...", {{image.dimX}}/2 - 40, {{image.dimY}}/2, true);

    // Log the draw time taken by the routine to the console.
    if(false)
    {
        var d = new Date();
        var endMilliseconds = d.getTime();
        console.log("Draw time: " + (endMilliseconds - currentMilliseconds) + " milliseconds.");
    }
};

function updateTable(id)
{
    var temp;

    switch(id)
    {
        case undefined:
            break;

        case 'feedbackButton':
        case 'sextractorEnabledCheckbox':
        case 'image2xyEnabledCheckbox':
        case 'daofindEnabledCheckbox':
        case 'starfindEnabledCheckbox':
        case 'sourceFindMatchesEnabledCheckbox':
        case 'methodEnabledLockCheckbox':
            if($('#methodEnabledLockCheckbox').is(':checked'))
            {
                if(id != 'methodEnabledLockCheckbox')
                    temp = $('#'+id).is(':checked');
                else
                    temp = $('#sextractorEnabledCheckbox').is(':checked');

                $('#sextractorEnabledCheckbox').prop('checked', temp)
                $('#image2xyEnabledCheckbox').prop('checked', temp)
                $('#daofindEnabledCheckbox').prop('checked', temp)
                $('#starfindEnabledCheckbox').prop('checked', temp)
                $('#sourceFindMatchesEnabledCheckbox').prop('checked', temp)
            }

            for(method in feedbackSubmittedDict)
            {
                if(!feedbackSubmittedDict[method])
                {
                    $('#' + method + 'FeedbackButtonDiv').show();
                    $('#' + method + 'ButtonDiv').hide();
                }
            }

            break;

        case 'sextractorSizeSlider':
        case 'image2xySizeSlider':
        case 'daofindSizeSlider':
        case 'starfindSizeSlider':
        case 'sourceFindMatchesSizeSlider':
        case 'methodSizeLockCheckbox':
            if($('#methodSizeLockCheckbox').is(':checked'))
            {
                if(id != 'methodSizeLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorSizeSlider').prop('value');

                $('#sextractorSizeSlider').prop('value', temp)
                $('#image2xySizeSlider').prop('value', temp)
                $('#daofindSizeSlider').prop('value', temp)
                $('#starfindSizeSlider').prop('value', temp)
                $('#sourceFindMatchesSizeSlider').prop('value', temp)
            }
            break;

        case 'sextractorSizeScaleSlider':
        case 'image2xySizeScaleSlider':
        case 'daofindSizeScaleSlider':
        case 'starfindSizeScaleSlider':
        case 'sourceFindMatchesSizeScaleSlider':
        case 'methodSizeScaleLockCheckbox':
            if($('#methodSizeScaleLockCheckbox').is(':checked'))
            {
                if(id != 'methodSizeScaleLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorSizeScaleSlider').prop('value');

                $('#sextractorSizeScaleSlider').prop('value', temp)
                $('#image2xySizeScaleSlider').prop('value', temp)
                $('#daofindSizeScaleSlider').prop('value', temp)
                $('#starfindSizeScaleSlider').prop('value', temp)
                $('#sourceFindMatchesSizeScaleSlider').prop('value', temp)
            }
            break;

        case 'sextractorLabelThresholdSlider':
        case 'image2xyLabelThresholdSlider':
        case 'daofindLabelThresholdSlider':
        case 'starfindLabelThresholdSlider':
        case 'sourceFindMatchesLabelThresholdSlider':
        case 'methodLabelThresholdLockCheckbox':
            if($('#methodLabelThresholdLockCheckbox').is(':checked'))
            {
                if(id != 'methodLabelThresholdLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorLabelThresholdSlider').prop('value');

                $('#sextractorLabelThresholdSlider').prop('value', temp)
                $('#image2xyLabelThresholdSlider').prop('value', temp)
                $('#daofindLabelThresholdSlider').prop('value', temp)
                $('#starfindLabelThresholdSlider').prop('value', temp)
                $('#sourceFindMatchesLabelThresholdSlider').prop('value', temp)
            }
            break;

        case 'sextractorLabelSizeSlider':
        case 'image2xyLabelSizeSlider':
        case 'daofindLabelSizeSlider':
        case 'starfindLabelSizeSlider':
        case 'sourceFindMatchesLabelSizeSlider':
        case 'methodLabelSizeLockCheckbox':
            if($('#methodLabelSizeLockCheckbox').is(':checked'))
            {
                if(id != 'methodLabelSizeLockCheckbox')
                    temp = $('#'+id).prop('value');
                else
                    temp = $('#sextractorLabelSizeSlider').prop('value');

                $('#sextractorLabelSizeSlider').prop('value', temp)
                $('#image2xyLabelSizeSlider').prop('value', temp)
                $('#daofindLabelSizeSlider').prop('value', temp)
                $('#starfindLabelSizeSlider').prop('value', temp)
                $('#sourceFindMatchesLabelSizeSlider').prop('value', temp)
            }
            break;
    }

    if($('#sextractorEnabledCheckbox').is(':checked'))
        $('.sextractorResults').css('background-color', sextractorColor);
    else
        $('.sextractorResults').css('background-color', 'transparent');

    if($('#image2xyEnabledCheckbox').is(':checked'))
        $('.image2xyResults').css('background-color', image2xyColor);
    else
        $('.image2xyResults').css('background-color', 'transparent');

    if($('#daofindEnabledCheckbox').is(':checked'))
        $('.daofindResults').css('background-color', daofindColor);
    else
        $('.daofindResults').css('background-color', 'transparent');

    if($('#starfindEnabledCheckbox').is(':checked'))
        $('.starfindResults').css('background-color', starfindColor);
    else
        $('.starfindResults').css('background-color', 'transparent');

    if($('#sourceFindMatchesEnabledCheckbox').is(':checked'))
        $('.sourceFindMatchesResults').css('background-color', sourceFindMatchesColor);
    else
        $('.sourceFindMatchesResults').css('background-color', 'transparent');

    drawSources();
};

function arraysEqual(arr1, arr2)
{
    if(arr1.length !== arr2.length)
        return false;
    for(var i = arr1.length; i--;)
    {
        if(arr1[i] !== arr2[i])
            return false;
    }

    return true;
};

function handleMouseMove(event)
{
    var rect = canvas.getBoundingClientRect();

    mouseX = event.clientX - rect.left;
    mouseY = {{image.dimY}} - (event.clientY - rect.top);

    if(!lmbDown && (event.clientX < rect.left || event.clientX >  rect.right || event.clientY < rect.top || event.clientY > rect.bottom))
        return true;

    oldMouseObjectsList = mouseObjectsList;
    mouseObjectsList = [];

    //TODO: Add an if statement for each source and only include it in this array if it is
    //checked up above.
    sourceLists = [];

    if($('#sextractorEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [sextractorResults, 'sextractor'];
    if($('#image2xyEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [image2xyResults, 'image2xy'];
    if($('#daofindEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [daofindResults, 'daofind'];
    if($('#starfindEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [starfindResults, 'starfind'];
    if($('#sourceFindMatchesEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [sourceFindMatches, 'multi'];
    if($('#objectsEnabledCheckbox').is(':checked'))
        sourceLists[sourceLists.length] = [objectsInImage, 'Catalog'];

    sourceLists[sourceLists.length] = [userCreatedResults, 'user - not uploaded'];
    sourceLists[sourceLists.length] = [userCreatedHotPixels, 'user - hot pixel - not uploaded'];
    sourceLists[sourceLists.length] = [userSubmittedResults, 'userSubmittedResult'];
    sourceLists[sourceLists.length] = [userSubmittedHotPixels, 'user - hot pixel'];

    for(var i = 0; i < sourceLists.length; i++)
    {
        currentList = sourceLists[i][0];
        currentMethod = sourceLists[i][1];

        for(var j = 0; j < currentList.length; j++)
        {
            currentSource = sourceLists[i][0][j];
            if(currentSource.pixelX != null)
            {
                x = currentSource.pixelX;
                y = currentSource.pixelY;
            }
            else
            {
                xyCoords = transformRADec(currentSource.ra, currentSource.dec)
                x = xyCoords[0]
                y = xyCoords[1]
            }
            deltaX = mouseX - x;
            deltaY = mouseY - y;
            dsq = deltaX*deltaX + deltaY*deltaY;
            if(dsq < maxDistanceFromStarSquared)
            {
                var mouseLength = mouseObjectsList.length;
                mouseObjectsList[mouseLength] = currentSource;
                mouseObjectsList[mouseLength].method = currentMethod;
            }
        }
    }

    if(mouseObjectsList.length > 0)
        mouseoverTextActive = true;
    else
        mouseoverTextActive = false;

    drawSources(false);
};

function handleMouseButtonDown(event)
{
    var i;

    if(mouseX < 0 || mouseX > {{image.dimX}} || mouseY < 0 || mouseY > {{image.dimY}})
        return true;

    // Left click without shift key held.
    if(event.which == 1 && !keyStatusDict['shift'])
    {
        lmbDown = true;
        mouseXStart = mouseX;
        mouseYStart = mouseY;

        drawSources();
    }

    // Left click with shift key held.
    if(event.which == 1 && keyStatusDict['shift'])
    {
        for(i = 0; i < mouseObjectsList.length; i++)
        {
            switch(mouseObjectsList[i].method)
            {
                case 'sextractor':
                case 'image2xy':
                case 'daofind':
                case 'starfind':
                case 'multi':
                case 'userSubmittedResult':
                    window.open('/detectedSource/' + mouseObjectsList[i].method + '/' + mouseObjectsList[i].id);
                    break;

                case 'user - hot pixel':
                    window.open('/detectedSource/userHotPixel/' + mouseObjectsList[i].id);
                    break;

                case 'Catalog':
                    window.open('/catalog/' + mouseObjectsList[i].catalog + '/' + mouseObjectsList[i].id);
                    break;

                case 'user - not uploaded':
                case 'user - hot pixel - not uploaded':
                    // This page intentionally left blank.
                    break;

                default:
                    alert('Unhandled url handler: ' + mouseObjectsList[i].method);
                    break;
            }
        }
    }
};

function handleMouseButtonUp(event)
{
    // Left click without shift key held.
    if(event.which == 1 && !keyStatusDict['shift'])
    {
        //NOTE: These lines are duplicated elsewhere, if they change the others must too.
        var deltaX = mouseX - mouseXStart;
        var deltaY = mouseY - mouseYStart;
        var xPos = mouseX - reticlePrecision*deltaX;
        var yPos = mouseY - reticlePrecision*deltaY;

        if(lmbDown && mode == 'stars')
            userCreatedResults[userCreatedResults.length] = {pixelX: xPos, pixelY: yPos, confidence: 1.0};
        else if(lmbDown && mode == 'hotpixels')
            userCreatedHotPixels[userCreatedHotPixels.length] = {pixelX: xPos, pixelY: yPos, confidence: 1.0};

        lmbDown = false;
        drawSources();
    }

    $('#uploadResultsNumDiv').html(userCreatedResults.length);
    $('#hotPixelsNumDiv').html(userCreatedHotPixels.length);

    if(!submitButtonEnabled && (userCreatedResults.length == 1 || userCreatedHotPixels.length == 1))
    {
        submitButtonEnabled = true;
        $('#uploadMarkedStarsButton').hide(1000);
        $('#uploadMarkedStarsButton').prop( "disabled", false );
        $('#uploadMarkedStarsButton').show(1000);
    }
};

function handleKeyDown(event)
{
    if(!lmbDown && (mouseX < 0 || mouseX > {{image.dimX}} || mouseY < 0 || mouseY > {{image.dimY}}))
        return true;

    //alert(keyCodeDict[event.which]);
    keyStatusDict[keyCodeDict[event.which]] = true;
    countKeysPressed();

    drawSources();
};

function handleKeyUp(event)
{
    keyStatusDict[keyCodeDict[event.which]] = false;
    countKeysPressed();

    drawSources();
};

function countKeysPressed()
{
    var count = 0;
    for(var key in keyStatusDict)
        if(keyStatusDict[key])
            count++;

    numKeysPressed = count;
    //alert(numKeysPressed);

    switch(numKeysPressed)
    {
        case 0:
            mode = 'stars';
            break;

        case 1:
            if(keyStatusDict['ctrl'])
                mode = 'hotpixels';
            break;

        case 2:
            if(keyStatusDict['ctrl'] && keyStatusDict['x'])
                mode = 'hotlines';
            else if(keyStatusDict['ctrl'] && keyStatusDict['c'])
                mode = 'hotcolumns';
            break;
    }
};

window.onload = function()
{
    canvas = document.getElementById("sourcesCanvas");
    context = canvas.getContext("2d");

    //TODO: There are probably bugs here where you click the mouse down on the canvas and then release it elsewhere in the window, etc.
    $(document).mousemove(handleMouseMove);
    $(document).mousedown(handleMouseButtonDown);
    $(document).mouseup(handleMouseButtonUp);
    $("#sourcesCanvas").mouseenter(function(){document.body.style.cursor = 'none';});
    $("#sourcesCanvas").mouseleave(function(){document.body.style.cursor = oldMouseCursor;
        mouseX = undefined; mouseY = undefined; drawSources();});
    $(document).keydown(handleKeyDown);
    $(document).keyup(handleKeyUp);
    countKeysPressed();
    updateTransformIncrement();

    $('#uploadMarkedStarsButton').prop( "disabled", true );

    var xdr = new Bokeh.DataRange1d({ follow: 'start' });
    var ydr = new Bokeh.DataRange1d({ follow: 'start' });

    plot = new Bokeh.Plotting.figure({
        toolbar_location: 'above',
        toolbar_sticky: false,
        x_range: xdr,
        y_range: ydr,
        plot_width: 600,
        plot_height: 600,
        background_fill_color: "#F2F2F7"
        });

    //TODO: One way to clear this plot would be to delete the innerHtml of this div and re-display the plot from scratch.
    div = document.getElementById("bokehPlotDiv");
    Bokeh.Plotting.show(plot, div);

    //TODO: Use the thumbnail url query rather than this hardcoded value, maybe?
    img = new Image();
    img.src = '{{image.getThumbnailUrlFull|safe}}';

    updateTable();

    getObjectsInImage();
    getUserSubmittedResults();
    getUserSubmittedHotPixels();
    getSextractorResults();
    getImage2xyResults();
    getDaofindResults();
    getStarfindResults();
    getSourceFindMatches();

};
</script>

{% endblock mainbody %}

