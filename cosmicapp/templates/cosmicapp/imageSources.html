{% extends "cosmicapp/base.html" %}
{% load static %}

{% block extratitle %} - Image {{id}} sources viewer {% endblock %}

{% block mainbody %}

<head>
  <script src="/static/cosmicapp/math.min.js" type="text/javascript"></script>
</head>

{% include "./jquery.html" %}

<table border=2px>
<tr>
<th></th>
<th>Sextractor</th>
<th>Daofind</th>
<th>Starfind</th>
<th>Multiple<br>Method<br>Matches</th>
</tr>
<tr>
<td>Size:</td>
<td><input id="sextractorSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="daofindSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="starfindSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="sourceFindMatchesSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
</tr>

<tr>
<td>Size scale:</td>
<td><input id="sextractorSizeScaleSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="daofindSizeScaleSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="starfindSizeScaleSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="sourceFindMatchesSizeScaleSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
</tr>

<tr>
<td>Label thresh:</td>
<td><input id="sextractorLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="daofindLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="starfindLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="sourceFindMatchesLabelThresholdSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
</tr>

<tr>
<td>Label size:</td>
<td><input id="sextractorLabelSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="daofindLabelSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="starfindLabelSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
<td><input id="sourceFindMatchesLabelSizeSlider" type=range min="0" max="100" value="50" onchange="drawSources()"></td>
</tr>

<tr>
<td>Label:</td>
    <td>
    <input type=checkbox id=sextractorLabelFlux onchange="drawSources()"> Flux<br>
    <input type=checkbox id=sextractorLabelFluxErr onchange="drawSources()"> Flux Err<br>
    <input type=checkbox id=sextractorLabelFlags onchange="drawSources()"> Flags<br>
    <input type=checkbox id=sextractorLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td>
    <input type=checkbox id=daofindLabelMag onchange="drawSources()"> Magnitude<br>
    <input type=checkbox id=daofindLabelSharpness onchange="drawSources()"> Sharpness<br>
    <input type=checkbox id=daofindLabelSRound onchange="drawSources()"> Symmetry roundness<br>
    <input type=checkbox id=daofindLabelGRound onchange="drawSources()"> Gaussian roundess<br>
    <input type=checkbox id=daofindLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td>
    <input type=checkbox id=starfindLabelMag onchange="drawSources()"> Magnitude<br>
    <input type=checkbox id=starfindLabelArea onchange="drawSources()"> Area<br>
    <input type=checkbox id=starfindLabelHWHM onchange="drawSources()"> HWHM<br>
    <input type=checkbox id=starfindLabelRoundness onchange="drawSources()"> Roundness<br>
    <input type=checkbox id=starfindLabelPA onchange="drawSources()"> PA<br>
    <input type=checkbox id=starfindLabelSharpness onchange="drawSources()"> Sharpness<br>
    <input type=checkbox id=starfindLabelConfidence onchange="drawSources()" checked> Confidence
    </td>

    <td>
    <input type=checkbox id=sourceFindMatchesLabelNum onchange="drawSources()"> Num Methods<br>
    <input type=checkbox id=sourceFindMatchesLabelConfidence onchange="drawSources()" checked> Confidence
    </td>
</tr>
</table>

<canvas id="sourcesCanvas" width="{{image.dimX}}" height="{{image.dimY}}" style="border:4px solid #00A030">
Your browser does not support the HTML5 canvas tag.
</canvas>

<script>
var imageId = {{id}};
var sextractorResults = [], daofindResults = [], starfindResults = [];
var sextractorResultsPromise, daofindResultsPromise, starfindResultsPromise;
var sourceFindMatches = [];
var canvas, context;
var img;
var sextractorColor = "#E02010";
var daofindColor = "#20E010";
var starfindColor = "#E0E020";
var sourceFindMatchesColor = "#FF7700";

function getObjectById(objectList, id)
{
    if(id == null)
        return null;

    for(index = 0; index < objectList.length; index++)
    {
        if(objectList[index].id == id)
            return objectList[index];
    }

    return null;
};

function getSextractorResults()
{
    sextractorResultsPromise = $.ajax({
        url : "/query/?queryfor=sextractorResult&limit=10000&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            results = xml.getElementsByTagName('SextractorResult')
            for(i = 0; i < results.length; i++)
            {
                attr = results[i].attributes;
                sextractorResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    fluxAuto: Number(attr.getNamedItem('fluxAuto').nodeValue),
                    fluxAutoErr: Number(attr.getNamedItem('fluxAutoErr').nodeValue),
                    flags: Number(attr.getNamedItem('flags').nodeValue)
                });

                sextractorResults[i].confidence = math.pow(sextractorResults[i].fluxAuto / sextractorResults[i].fluxAutoErr, 2);
            }

            drawSources();
            Promise.resolve(true);
        }
    });
};

function getDaofindResults()
{
    daofindResultsPromise = $.ajax({
        url : "/query/?queryfor=daofindResult&limit=10000&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            results = xml.getElementsByTagName('DaofindResult')
            for(i = 0; i < results.length; i++)
            {
                attr = results[i].attributes;
                daofindResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    mag: Number(attr.getNamedItem('mag').nodeValue),
                    sharpness: Number(attr.getNamedItem('sharpness').nodeValue),
                    sround: Number(attr.getNamedItem('sround').nodeValue),
                    ground: Number(attr.getNamedItem('ground').nodeValue)
                });

                daofindResults[i].confidence = 10.0/(math.pow(daofindResults[i].sharpness - 0.4, 2) + 0.1)
                                             + 1.0/(math.abs(daofindResults[i].sround) + 0.1)
                                             + 1.0/(math.abs(daofindResults[i].ground) + 0.1)
                                             + 100*math.pow(daofindResults[i].mag, 2);
            }

            drawSources();
            Promise.resolve(true);
        }
    });
};

function getStarfindResults()
{
    starfindResultsPromise = $.ajax({
        url : "/query/?queryfor=starfindResult&limit=10000&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            results = xml.getElementsByTagName('StarfindResult')
            for(i = 0; i < results.length; i++)
            {
                attr = results[i].attributes;
                starfindResults[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    x: Number(attr.getNamedItem('pixelX').nodeValue),
                    y: Number(attr.getNamedItem('pixelY').nodeValue),
                    z: Number(attr.getNamedItem('pixelZ').nodeValue),
                    mag: Number(attr.getNamedItem('mag').nodeValue),
                    area: Number(attr.getNamedItem('area').nodeValue),
                    hwhm: Number(attr.getNamedItem('hwhm').nodeValue),
                    roundness: Number(attr.getNamedItem('roundness').nodeValue),
                    pa: Number(attr.getNamedItem('pa').nodeValue),
                    sharpness: Number(attr.getNamedItem('sharpness').nodeValue)
                });

                starfindResults[i].confidence = 10.0/(math.pow(starfindResults[i].sharpness - 1.2, 2) + 0.1)
                                             + 1.0/(math.abs(starfindResults[i].roundness) + 0.1)
                                             + 1*(math.pow(starfindResults[i].area, 2) + 0.1)
                                             + 1*math.pow(starfindResults[i].mag, 2);
            }

            drawSources();
            Promise.resolve(true);
        }
    });
};

function getSourceFindMatches()
{
    $.ajax({
        url : "/query/?queryfor=sourceFindMatch&limit=10000&imageId=" + imageId,
        type : "get",
        async: true,
        success : function(xml)
        {
            results = xml.getElementsByTagName('SourceFindMatch')
            for(i = 0; i < results.length; i++)
            {
                attr = results[i].attributes;

                sextractorId = null, daofindId = null, starfindId = null;
                if(attr.getNamedItem('sextractorResult') != null)
                    sextractorId = Number(attr.getNamedItem('sextractorResult').nodeValue);

                if(attr.getNamedItem('daofindResult') != null)
                    daofindId = Number(attr.getNamedItem('daofindResult').nodeValue);

                if(attr.getNamedItem('starfindResult') != null)
                    starfindId = Number(attr.getNamedItem('starfindResult').nodeValue);

                sourceFindMatches[i] = new Object({
                    id: Number(attr.getNamedItem('id').nodeValue),
                    sextractorResultId: sextractorId,
                    daofindResultId: daofindId,
                    starfindResultId: starfindId
                });

                //TODO: Since this code depends on accessing other objects we will need to break it out into a function
                //and call it again every time new objects are added to the lists.
                sourceFindMatches[i].sextractorResult = getObjectById(sextractorResults, sourceFindMatches[i].sextractorResultId);
                sourceFindMatches[i].daofindResult = getObjectById(daofindResults, sourceFindMatches[i].daofindResultId);
                sourceFindMatches[i].starfindResult = getObjectById(starfindResults, sourceFindMatches[i].starfindResultId);

                x = 0, y = 0, confidence = 1, num = 0;
                if(sourceFindMatches[i].sextractorResult != null)
                {
                    x += sourceFindMatches[i].sextractorResult.x;
                    y += sourceFindMatches[i].sextractorResult.y;
                    confidence *= sourceFindMatches[i].sextractorResult.confidence;
                    num++;
                }

                if(sourceFindMatches[i].daofindResult != null)
                {
                    x += sourceFindMatches[i].daofindResult.x;
                    y += sourceFindMatches[i].daofindResult.y;
                    confidence *= sourceFindMatches[i].daofindResult.confidence;
                    num++;
                }

                if(sourceFindMatches[i].starfindResult != null)
                {
                    x += sourceFindMatches[i].starfindResult.x;
                    y += sourceFindMatches[i].starfindResult.y;
                    confidence *= sourceFindMatches[i].starfindResult.confidence;
                    num++;
                }

                sourceFindMatches[i].x = x/num;
                sourceFindMatches[i].y = y/num;

                sourceFindMatches[i].num = num;
                sourceFindMatches[i].confidence = confidence;
            }

            drawSources();
            Promise.resolve(true);
        }
    });
};

function drawSources()
{
    context.drawImage(img, 0, 0);

    context.strokeStyle = sextractorColor;
    context.fillStyle = context.strokeStyle;

    sizeFactor = $('#sextractorSizeSlider').val()/250.0;
    sizeScaleFactor = $('#sextractorSizeScaleSlider').val()/30.0;
    labelThreshold = $('#sextractorLabelThresholdSlider').val()*10;
    labelSize= $('#sextractorLabelSizeSlider').val()/5 + 10
    for(i = 0; i < sextractorResults.length; i++)
    {
        context.beginPath();
        context.arc(sextractorResults[i].x, {{image.dimY}} - sextractorResults[i].y,
            sizeFactor*Math.pow(Math.log(sextractorResults[i].fluxAuto), sizeScaleFactor), 0, 2*Math.PI)
        context.stroke();

        if(sextractorResults[i].confidence > labelThreshold)
        {
            labelArray = [];

            if($('#sextractorLabelFlux').is(':checked'))
                labelArray[labelArray.length] = math.round(sextractorResults[i].fluxAuto, 2);

            if($('#sextractorLabelFluxErr').is(':checked'))
                labelArray[labelArray.length] = math.round(sextractorResults[i].fluxAutoErr, 2);

            if($('#sextractorLabelFlags').is(':checked'))
                labelArray[labelArray.length] = sextractorResults[i].flags;

            if($('#sextractorLabelConfidence').is(':checked'))
                labelArray[labelArray.length] = math.round(sextractorResults[i].confidence, 0);

            labelText = labelArray.join(' ');
            context.font = labelSize + 'px sans-serif'
            context.fillText(labelText, sextractorResults[i].x + labelSize/2, {{image.dimY}} - sextractorResults[i].y - labelSize)
        }
    }

    context.strokeStyle = daofindColor;
    context.fillStyle = context.strokeStyle;

    sizeFactor = $('#daofindSizeSlider').val()/50.0;
    sizeScaleFactor = $('#daofindSizeScaleSlider').val()/150.0;
    labelThreshold = $('#daofindLabelThresholdSlider').val()*20;
    labelSize= $('#daofindLabelSizeSlider').val()/5 + 10
    for(i = 0; i < daofindResults.length; i++)
    {
        context.beginPath();
        context.arc(daofindResults[i].x, {{image.dimY}} - daofindResults[i].y,
            sizeFactor*Math.pow(math.abs(daofindResults[i].confidence), sizeScaleFactor), 0, 2*Math.PI)
        context.stroke();

        if(daofindResults[i].confidence > labelThreshold)
        {
            labelArray = [];

            if($('#daofindLabelMag').is(':checked'))
                labelArray[labelArray.length] = math.round(daofindResults[i].mag, 2);

            if($('#daofindLabelSharpness').is(':checked'))
                labelArray[labelArray.length] = math.round(daofindResults[i].sharpness, 2);

            if($('#daofindLabelSRound').is(':checked'))
                labelArray[labelArray.length] = math.round(daofindResults[i].sround, 2);

            if($('#daofindLabelGRound').is(':checked'))
                labelArray[labelArray.length] = math.round(daofindResults[i].ground, 2);

            if($('#daofindLabelConfidence').is(':checked'))
                labelArray[labelArray.length] = math.round(daofindResults[i].confidence, 0);

            labelText = labelArray.join(' ');
            context.font = labelSize + 'px sans-serif'
            context.fillText(labelText, daofindResults[i].x + labelSize/2, {{image.dimY}} - daofindResults[i].y)
        }
    }

    context.strokeStyle = starfindColor;
    context.fillStyle = context.strokeStyle;

    sizeFactor = $('#starfindSizeSlider').val()/50.0;
    sizeScaleFactor = $('#starfindSizeScaleSlider').val()/150.0;
    labelThreshold = $('#starfindLabelThresholdSlider').val()*20;
    labelSize= $('#starfindLabelSizeSlider').val()/5 + 10
    for(i = 0; i < starfindResults.length; i++)
    {
        context.beginPath();
        context.arc(starfindResults[i].x, {{image.dimY}} - starfindResults[i].y,
            sizeFactor*Math.pow(math.abs(starfindResults[i].confidence), sizeScaleFactor), 0, 2*Math.PI)
        context.stroke();

        if(starfindResults[i].confidence > labelThreshold)
        {
            labelArray = [];

            if($('#starfindLabelMag').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].mag, 2);

            if($('#starfindLabelArea').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].area, 2);

            if($('#starfindLabelHWHM').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].hwhm, 2);

            if($('#starfindLabelRoundness').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].roundness, 2);

            if($('#starfindLabelPA').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].pa, 2);

            if($('#starfindLabelSharpness').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].sharpness, 2);

            if($('#starfindLabelConfidence').is(':checked'))
                labelArray[labelArray.length] = math.round(starfindResults[i].confidence, 0);

            labelText = labelArray.join(' ');
            context.font = labelSize + 'px sans-serif'
            context.fillText(labelText, starfindResults[i].x + labelSize/2, {{image.dimY}} - starfindResults[i].y + labelSize)
        }
    }

    context.strokeStyle = sourceFindMatchesColor;
    context.fillStyle = context.strokeStyle;

    sizeFactor = $('#sourceFindMatchesSizeSlider').val()/500.0;
    sizeScaleFactor = $('#sourceFindMatchesSizeScaleSlider').val()/300.0;
    labelThreshold = $('#sourceFindMatchesLabelThresholdSlider').val()*500;
    labelSize= $('#sourceFindMatchesLabelSizeSlider').val()/5 + 10
    for(i = 0; i < sourceFindMatches.length; i++)
    {
        context.beginPath();
        context.arc(sourceFindMatches[i].x, {{image.dimY}} - sourceFindMatches[i].y,
            sizeFactor*Math.pow(math.abs(sourceFindMatches[i].confidence), sizeScaleFactor), 0, 2*Math.PI)
        context.stroke();

        if(sourceFindMatches[i].confidence > labelThreshold)
        {
            labelArray = [];

            if($('#sourceFindMatchesLabelNum').is(':checked'))
                labelArray[labelArray.length] = math.round(sourceFindMatches[i].num, 0);

            if($('#sourceFindMatchesLabelConfidence').is(':checked'))
                labelArray[labelArray.length] = math.round(sourceFindMatches[i].confidence, 0);

            labelText = labelArray.join(' ');
            context.font = labelSize + 'px sans-serif'
            context.textAlign = 'end';
            context.fillText(labelText, sourceFindMatches[i].x - labelSize/2, {{image.dimY}} - sourceFindMatches[i].y)
            context.textAlign = 'start';
        }
    }
};

window.onload = function()
{
    canvas = document.getElementById("sourcesCanvas");
    context = canvas.getContext("2d");

    //TODO: Use the thumbnail url query rather than this hardcoded value, maybe?
    img = new Image();
    img.src = '{{image.getThumbnailUrlFull|safe}}';

    drawSources();

    getSextractorResults();
    getDaofindResults();
    getStarfindResults();
    $.when(sextractorResultsPromise, daofindResultsPromise, starfindResultsPromise).done(getSourceFindMatches);
};
</script>
{% endblock %}

