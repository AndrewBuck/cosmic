{% extends "cosmicapp/base.html" %}

{% load static %}
{% load cosmicapp_extras %}

{% block extratitle %} - Sky map {% endblock extratitle %}

{% block extrahead %}
{% include "../jquery.html" %}
{% comment %}
{% if user.is_authenticated %}<script src="/static/cosmicapp/bookmark.js"></script>{% endif %}
<script src="/static/cosmicapp/imageTable.js"></script>
<script src="/static/cosmicapp/raDec.js"></script>
<script src="/static/cosmicapp/math.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="/static/cosmicapp/bokeh-0.12.9.min.css">
<script src="/static/cosmicapp/bokeh-0.12.9.min.js"></script>
<script src="/static/cosmicapp/bokeh-api-0.12.9.min.js"></script>
{% endcomment %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>

<script>
var mlat = '{{markerLat}}';
var mlon = '{{markerLon}}';
var plateSolution = '{{plateSolution}}';
var plateSolutions = [];

$( document ).ready(function()
{
    var mymap = L.map('mapid').setView([{{startingLat}}, {{startingLon}}], {{startingZoom}});

    if(mlat != '' && mlon != '')
        var marker = L.marker([{{markerLat}}, {{markerLon}}]).addTo(mymap);

    L.tileLayer('/map/{id}/tiles/{z}/{x}/{y}.png',
    {
        attribution: 'Cosmic.science',
        maxZoom: 18,
        id: 'sky',
    }).addTo(mymap);

    mymap.on('moveend', function(ev)
    {
        var html = '';
        var center = mymap.getCenter();
        html += '<a href="/map/sky/?zoom=' + mymap.getZoom() + '&lat=' + center.lat + '&lon=' + center.lng;

        if(mlat != '' && mlon != '')
            html += '&mlat=' + mlat + '&mlon=' + mlon;

        html += '">Permalink</a>';
        $('#permalinkDiv').html(html);
    });

    mymap.fire('moveend');

    if(plateSolution != '')
    {
        $.ajax({
            url : "/query/?queryfor=plateSolution&id=" + plateSolution,
            type : "get",
            async: true,
            dataType: 'json',
            success : function(response)
            {
                var bounds;

                plateSolutions = response;
                for(i = 0; i < plateSolutions.length; i++)
                {
                    var polygon = L.polygon(plateSolutions[i].footprint, {color: 'red'}).addTo(mymap);
                    if(i == 0)
                        bounds = polygon.getBounds();
                    else
                        bounds = bounds.extend(polygon.getBounds());
                }

                if(plateSolutions.length > 0)
                    mymap.fitBounds(bounds);
            }
        });
    }
});
</script>

{% endblock extrahead %}

{% block mainbody %}
<h2>Sky map</h2>

<div id="permalinkDiv"></div>

<div id="mapid" style="height: 600px; width: 80%; margin: auto;"></div>

{% endblock mainbody %}
